Process LiPD Data for HoloceneHydrocliamte
================
Chris Hancock

``` r
library(lipdR)
library(proj4)
library(RCurl)
library(sf)
library(sp)
library(tidyverse)

print("Packages Loaded")
```

    ## [1] "Packages Loaded"

``` r
save<-TRUE
tempVers <- '1_0_2' #Which versions of temp12k datesets to use
hcVers   <- '0_7_0' #Which versions of Holocene hydroclimate datesets to use
```

``` r
#Load IPCC Region Spatial Data
PROJ     <- '+proj=robin   +ellps=WGS84 +datum=WGS84 +no_defs +lon_0=0 +x_0=0 +y_0=0 +units=m'
PROJorig <- "+proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs"
load(url('https://github.com/SantanderMetGroup/ATLAS/blob/main/reference-regions/IPCC-WGI-reference-regions-v4_R.rda?raw=true'), verbose = TRUE)
```

    ## Loading objects:
    ##   IPCC_WGI_reference_regions_v4

``` r
refregions <-  spTransform(IPCC_WGI_reference_regions_v4, CRSobj = PROJ)
```

#### Load Proxy Data

``` r
D__t <- readLipd(paste0('https://lipdverse.org/Temp12k/',tempVers,'/Temp12k',tempVers,'.zip'))
```

    ## [1] "Loading 698 datasets from /var/folders/h9/3rpf_h5j01bcy6dw2hfhdm140000gn/T//RtmpxA5apQ/lpdDownload..."
    ##   |                                                                              |                                                                      |   0%  |                                                                              |                                                                      |   1%  |                                                                              |=                                                                     |   1%  |                                                                              |=                                                                     |   2%  |                                                                              |==                                                                    |   2%  |                                                                              |==                                                                    |   3%  |                                                                              |===                                                                   |   4%  |                                                                              |===                                                                   |   5%  |                                                                              |====                                                                  |   5%  |                                                                              |====                                                                  |   6%  |                                                                              |=====                                                                 |   6%  |                                                                              |=====                                                                 |   7%  |                                                                              |=====                                                                 |   8%  |                                                                              |======                                                                |   8%  |                                                                              |======                                                                |   9%  |                                                                              |=======                                                               |   9%  |                                                                              |=======                                                               |  10%  |                                                                              |=======                                                               |  11%  |                                                                              |========                                                              |  11%  |                                                                              |========                                                              |  12%  |                                                                              |=========                                                             |  12%  |                                                                              |=========                                                             |  13%  |                                                                              |==========                                                            |  14%  |                                                                              |==========                                                            |  15%  |                                                                              |===========                                                           |  15%  |                                                                              |===========                                                           |  16%  |                                                                              |============                                                          |  16%  |                                                                              |============                                                          |  17%  |                                                                              |============                                                          |  18%  |                                                                              |=============                                                         |  18%  |                                                                              |=============                                                         |  19%  |                                                                              |==============                                                        |  19%  |                                                                              |==============                                                        |  20%  |                                                                              |==============                                                        |  21%  |                                                                              |===============                                                       |  21%  |                                                                              |===============                                                       |  22%  |                                                                              |================                                                      |  22%  |                                                                              |================                                                      |  23%  |                                                                              |=================                                                     |  24%  |                                                                              |=================                                                     |  25%  |                                                                              |==================                                                    |  25%  |                                                                              |==================                                                    |  26%  |                                                                              |===================                                                   |  27%  |                                                                              |===================                                                   |  28%  |                                                                              |====================                                                  |  28%  |                                                                              |====================                                                  |  29%  |                                                                              |=====================                                                 |  29%  |                                                                              |=====================                                                 |  30%  |                                                                              |=====================                                                 |  31%  |                                                                              |======================                                                |  31%  |                                                                              |======================                                                |  32%  |                                                                              |=======================                                               |  32%  |                                                                              |=======================                                               |  33%  |                                                                              |=======================                                               |  34%  |                                                                              |========================                                              |  34%  |                                                                              |========================                                              |  35%  |                                                                              |=========================                                             |  35%  |                                                                              |=========================                                             |  36%  |                                                                              |==========================                                            |  37%  |                                                                              |==========================                                            |  38%  |                                                                              |===========================                                           |  38%  |                                                                              |===========================                                           |  39%  |                                                                              |============================                                          |  39%  |                                                                              |============================                                          |  40%  |                                                                              |============================                                          |  41%  |                                                                              |=============================                                         |  41%  |                                                                              |=============================                                         |  42%  |                                                                              |==============================                                        |  42%  |                                                                              |==============================                                        |  43%  |                                                                              |==============================                                        |  44%  |                                                                              |===============================                                       |  44%  |                                                                              |===============================                                       |  45%  |                                                                              |================================                                      |  45%  |                                                                              |================================                                      |  46%  |                                                                              |=================================                                     |  47%  |                                                                              |=================================                                     |  48%  |                                                                              |==================================                                    |  48%  |                                                                              |==================================                                    |  49%  |                                                                              |===================================                                   |  49%  |                                                                              |===================================                                   |  50%  |                                                                              |===================================                                   |  51%  |                                                                              |====================================                                  |  51%  |                                                                              |====================================                                  |  52%  |                                                                              |=====================================                                 |  52%  |                                                                              |=====================================                                 |  53%  |                                                                              |======================================                                |  54%  |                                                                              |======================================                                |  55%  |                                                                              |=======================================                               |  55%  |                                                                              |=======================================                               |  56%  |                                                                              |========================================                              |  56%  |                                                                              |========================================                              |  57%  |                                                                              |========================================                              |  58%  |                                                                              |=========================================                             |  58%  |                                                                              |=========================================                             |  59%  |                                                                              |==========================================                            |  59%  |                                                                              |==========================================                            |  60%  |                                                                              |==========================================                            |  61%  |                                                                              |===========================================                           |  61%  |                                                                              |===========================================                           |  62%  |                                                                              |============================================                          |  62%  |                                                                              |============================================                          |  63%  |                                                                              |=============================================                         |  64%  |                                                                              |=============================================                         |  65%  |                                                                              |==============================================                        |  65%  |                                                                              |==============================================                        |  66%  |                                                                              |===============================================                       |  66%  |                                                                              |===============================================                       |  67%  |                                                                              |===============================================                       |  68%  |                                                                              |================================================                      |  68%  |                                                                              |================================================                      |  69%  |                                                                              |=================================================                     |  69%  |                                                                              |=================================================                     |  70%  |                                                                              |=================================================                     |  71%  |                                                                              |==================================================                    |  71%  |                                                                              |==================================================                    |  72%  |                                                                              |===================================================                   |  72%  |                                                                              |===================================================                   |  73%  |                                                                              |====================================================                  |  74%  |                                                                              |====================================================                  |  75%  |                                                                              |=====================================================                 |  75%  |                                                                              |=====================================================                 |  76%  |                                                                              |======================================================                |  77%  |                                                                              |======================================================                |  78%  |                                                                              |=======================================================               |  78%  |                                                                              |=======================================================               |  79%  |                                                                              |========================================================              |  79%  |                                                                              |========================================================              |  80%  |                                                                              |========================================================              |  81%  |                                                                              |=========================================================             |  81%  |                                                                              |=========================================================             |  82%  |                                                                              |==========================================================            |  82%  |                                                                              |==========================================================            |  83%  |                                                                              |==========================================================            |  84%  |                                                                              |===========================================================           |  84%  |                                                                              |===========================================================           |  85%  |                                                                              |============================================================          |  85%  |                                                                              |============================================================          |  86%  |                                                                              |=============================================================         |  87%  |                                                                              |=============================================================         |  88%  |                                                                              |==============================================================        |  88%  |                                                                              |==============================================================        |  89%  |                                                                              |===============================================================       |  89%  |                                                                              |===============================================================       |  90%  |                                                                              |===============================================================       |  91%  |                                                                              |================================================================      |  91%  |                                                                              |================================================================      |  92%  |                                                                              |=================================================================     |  92%  |                                                                              |=================================================================     |  93%  |                                                                              |=================================================================     |  94%  |                                                                              |==================================================================    |  94%  |                                                                              |==================================================================    |  95%  |                                                                              |===================================================================   |  95%  |                                                                              |===================================================================   |  96%  |                                                                              |====================================================================  |  97%  |                                                                              |====================================================================  |  98%  |                                                                              |===================================================================== |  98%  |                                                                              |===================================================================== |  99%  |                                                                              |======================================================================|  99%  |                                                                              |======================================================================| 100%
    ## 
    ## [1] "Successfully loaded 698 datasets, with 0 failure(s)."

``` r
D_hc <- readLipd(paste0('https://lipdverse.org/HoloceneHydroclimate/',hcVers,'/HoloceneHydroclimate',hcVers,'.zip'))
```

    ## [1] "Loading 749 datasets from /var/folders/h9/3rpf_h5j01bcy6dw2hfhdm140000gn/T//RtmpxA5apQ/lpdDownload..."
    ##   |                                                                              |                                                                      |   0%  |                                                                              |                                                                      |   1%  |                                                                              |=                                                                     |   1%  |                                                                              |=                                                                     |   2%  |                                                                              |==                                                                    |   2%  |                                                                              |==                                                                    |   3%  |                                                                              |===                                                                   |   4%  |                                                                              |===                                                                   |   5%  |                                                                              |====                                                                  |   5%  |                                                                              |====                                                                  |   6%  |                                                                              |=====                                                                 |   7%  |                                                                              |=====                                                                 |   8%  |                                                                              |======                                                                |   8%  |                                                                              |======                                                                |   9%  |                                                                              |=======                                                               |   9%  |                                                                              |=======                                                               |  10%  |                                                                              |=======                                                               |  11%  |                                                                              |========                                                              |  11%  |                                                                              |========                                                              |  12%  |                                                                              |=========                                                             |  12%  |                                                                              |=========                                                             |  13%  |                                                                              |==========                                                            |  14%  |                                                                              |==========                                                            |  15%  |                                                                              |===========                                                           |  15%  |                                                                              |===========                                                           |  16%  |                                                                              |============                                                          |  17%  |                                                                              |============                                                          |  18%  |                                                                              |=============                                                         |  18%  |                                                                              |=============                                                         |  19%  |                                                                              |==============                                                        |  19%  |                                                                              |==============                                                        |  20%  |                                                                              |==============                                                        |  21%  |                                                                              |===============                                                       |  21%  |                                                                              |===============                                                       |  22%  |                                                                              |================                                                      |  22%  |                                                                              |================                                                      |  23%  |                                                                              |=================                                                     |  24%  |                                                                              |=================                                                     |  25%  |                                                                              |==================                                                    |  25%  |                                                                              |==================                                                    |  26%  |                                                                              |===================                                                   |  26%  |                                                                              |===================                                                   |  27%  |                                                                              |===================                                                   |  28%  |                                                                              |====================                                                  |  28%  |                                                                              |====================                                                  |  29%  |                                                                              |=====================                                                 |  29%  |                                                                              |=====================                                                 |  30%  |                                                                              |=====================                                                 |  31%  |                                                                              |======================                                                |  31%  |                                                                              |======================                                                |  32%  |                                                                              |=======================                                               |  32%  |                                                                              |=======================                                               |  33%  |                                                                              |=======================                                               |  34%  |                                                                              |========================                                              |  34%  |                                                                              |========================                                              |  35%  |                                                                              |=========================                                             |  35%  |                                                                              |=========================                                             |  36%  |                                                                              |==========================                                            |  36%  |                                                                              |==========================                                            |  37%  |                                                                              |==========================                                            |  38%  |                                                                              |===========================                                           |  38%  |                                                                              |===========================                                           |  39%  |                                                                              |============================                                          |  39%  |                                                                              |============================                                          |  40%  |                                                                              |============================                                          |  41%  |                                                                              |=============================                                         |  41%  |                                                                              |=============================                                         |  42%  |                                                                              |==============================                                        |  42%  |                                                                              |==============================                                        |  43%  |                                                                              |==============================                                        |  44%  |                                                                              |===============================                                       |  44%  |                                                                              |===============================                                       |  45%  |                                                                              |================================                                      |  45%  |                                                                              |================================                                      |  46%  |                                                                              |=================================                                     |  46%  |                                                                              |=================================                                     |  47%  |                                                                              |=================================                                     |  48%  |                                                                              |==================================                                    |  48%  |                                                                              |==================================                                    |  49%  |                                                                              |===================================                                   |  49%  |                                                                              |===================================                                   |  50%  |                                                                              |===================================                                   |  51%  |                                                                              |====================================                                  |  51%  |                                                                              |====================================                                  |  52%  |                                                                              |=====================================                                 |  52%  |                                                                              |=====================================                                 |  53%  |                                                                              |=====================================                                 |  54%  |                                                                              |======================================                                |  54%  |                                                                              |======================================                                |  55%  |                                                                              |=======================================                               |  55%  |                                                                              |=======================================                               |  56%  |                                                                              |========================================                              |  56%  |                                                                              |========================================                              |  57%  |                                                                              |========================================                              |  58%  |                                                                              |=========================================                             |  58%  |                                                                              |=========================================                             |  59%  |                                                                              |==========================================                            |  59%  |                                                                              |==========================================                            |  60%  |                                                                              |==========================================                            |  61%  |                                                                              |===========================================                           |  61%  |                                                                              |===========================================                           |  62%  |                                                                              |============================================                          |  62%  |                                                                              |============================================                          |  63%  |                                                                              |============================================                          |  64%  |                                                                              |=============================================                         |  64%  |                                                                              |=============================================                         |  65%  |                                                                              |==============================================                        |  65%  |                                                                              |==============================================                        |  66%  |                                                                              |===============================================                       |  66%  |                                                                              |===============================================                       |  67%  |                                                                              |===============================================                       |  68%  |                                                                              |================================================                      |  68%  |                                                                              |================================================                      |  69%  |                                                                              |=================================================                     |  69%  |                                                                              |=================================================                     |  70%  |                                                                              |=================================================                     |  71%  |                                                                              |==================================================                    |  71%  |                                                                              |==================================================                    |  72%  |                                                                              |===================================================                   |  72%  |                                                                              |===================================================                   |  73%  |                                                                              |===================================================                   |  74%  |                                                                              |====================================================                  |  74%  |                                                                              |====================================================                  |  75%  |                                                                              |=====================================================                 |  75%  |                                                                              |=====================================================                 |  76%  |                                                                              |======================================================                |  77%  |                                                                              |======================================================                |  78%  |                                                                              |=======================================================               |  78%  |                                                                              |=======================================================               |  79%  |                                                                              |========================================================              |  79%  |                                                                              |========================================================              |  80%  |                                                                              |========================================================              |  81%  |                                                                              |=========================================================             |  81%  |                                                                              |=========================================================             |  82%  |                                                                              |==========================================================            |  82%  |                                                                              |==========================================================            |  83%  |                                                                              |===========================================================           |  84%  |                                                                              |===========================================================           |  85%  |                                                                              |============================================================          |  85%  |                                                                              |============================================================          |  86%  |                                                                              |=============================================================         |  87%  |                                                                              |=============================================================         |  88%  |                                                                              |==============================================================        |  88%  |                                                                              |==============================================================        |  89%  |                                                                              |===============================================================       |  89%  |                                                                              |===============================================================       |  90%  |                                                                              |===============================================================       |  91%  |                                                                              |================================================================      |  91%  |                                                                              |================================================================      |  92%  |                                                                              |=================================================================     |  92%  |                                                                              |=================================================================     |  93%  |                                                                              |==================================================================    |  94%  |                                                                              |==================================================================    |  95%  |                                                                              |===================================================================   |  95%  |                                                                              |===================================================================   |  96%  |                                                                              |====================================================================  |  97%  |                                                                              |====================================================================  |  98%  |                                                                              |===================================================================== |  98%  |                                                                              |===================================================================== |  99%  |                                                                              |======================================================================|  99%  |                                                                              |======================================================================| 100%
    ## 
    ## [1] "Successfully loaded 749 datasets, with 0 failure(s)."

#### Extract timeseries from LiPD files

``` r
TS__t_all <- splitInterpretationByScope(extractTs(D__t))
TS_hc_all <- splitInterpretationByScope(extractTs(D_hc))


getTSfromLiPDs <- function(input,compilationName,versNo){
  out <- vector(mode='list')
  for (tso in input){
    tsNo <- 1
    while (!is.null(tso[[paste('inCompilationBeta',tsNo,'_compilationName',sep='')]])){
      tsName <- tso[[paste('inCompilationBeta',tsNo,'_compilationName',sep='')]]
      tsVers <- tso[[paste('inCompilationBeta',tsNo,'_compilationVersion',sep='')]]
      if (tsName == compilationName & any(tsVers == versNo)){out[[length(out)+1]] <- tso}
      tsNo <- tsNo+1
    }
  }
  return(out)
}

TS__t <- getTSfromLiPDs(TS__t_all,'Temp12k',             tempVers)
TS_hc <- getTSfromLiPDs(TS_hc_all,'HoloceneHydroclimate',hcVers)

print(paste("Temp:",length(TS__t)))
```

    ## [1] "Temp: 1321"

``` r
print(paste("HC:",  length(TS_hc)))
```

    ## [1] "HC: 819"

``` r
lipdData <- list(T = TS__t, HC = TS_hc)
```

#### Add region metadata and standardize seasonality and climate variable names

``` r
metadata <- c("climateInterpretation1_seasonalityGeneral",
              "climateInterpretation1_variable")
for (name in metadata){
  print(paste("Original",name,":",list(unique(pullTsVariable(lipdData$HC,name)))))
}
```

    ## [1] "Original climateInterpretation1_seasonalityGeneral : c(\"Annual\", \"summerOnly\", \"winterOnly\", \"summer+\", \"winter+\")"
    ## [1] "Original climateInterpretation1_variable : c(\"P-E\", \"P\", \"M\")"

``` r
#
for (var in names(lipdData)){
  for (ts in 1:length(lipdData[[var]])){
    #
    #Load basic information for each record
    #
    tso                  <- lipdData[[var]][[ts]]
    tso$age              <- as.numeric(tso$age)
    tso$paleoData_values <- as.numeric(tso$paleoData_values)
    #
    #Add Ipcc regions to metadata
    #
    pointData <- data.frame(longitude=c(tso$geo_longitude),latitude=c(tso$geo_latitude))
    pointData <- spTransform(SpatialPointsDataFrame(coords=pointData,data = pointData, proj4string = CRS(PROJorig)),CRSobj = PROJ)
    tso$geo_ipccRegion <- as.character(over(pointData, refregions)$Acronym)
    #
    #Add Holocene age information
    #
    df <- data.frame(age    = as.numeric(tso$age), 
                     values = as.numeric(tso$paleoData_values)) %>%
      filter(between(age,-100,12400)) %>%
      filter(!is.na(values)) %>%
      arrange(age)
    tso$ageMin     <- max(min(df$age),0)
    tso$ageMax     <- min(max(df$age),12000)
    tso$ageRange   <- tso$ageMax-tso$ageMin
    tso$ageRes     <- median(diff(df$age))
    tso$ageResPlus <- median(diff(df$age[which(diff(df$values) != 0)]))
    tso$paleoData_HoloceneValues <- df
    #
    #Make sure name of climate interp field is standardized 
    #
    if (is.null(tso$climateInterpretation1_direction) == FALSE){
      tso$climateInterpretation1_interpDirection <- tso$climateInterpretation1_direction
    }
    #
    #Standardize seasonality & interpretation variable (M->P-E)
    #
    if (var == 'HC'){
      szn <- tso$climateInterpretation1_seasonalityGeneral
      if (is.null(szn)){                                szn <- 'Annual'
      } else if        (grepl('ummer',szn)){ 
        if (substr(szn, nchar(szn), nchar(szn)) == '+'){szn <- 'Summer+'
        } else{                                         szn <- 'Summer'}
      } else if (grepl('inter',szn)){ 
        if (substr(szn, nchar(szn), nchar(szn)) == '+'){szn <- 'Winter+'} 
        else{                                           szn <- 'Winter'}
      } else {                                          szn <- 'Annual'} 
      tso$climateInterpretation1_seasonalityGeneral <- szn
      #
      if (is.null(tso$climateInterpretation1_variable) | tso$climateInterpretation1_variable == 'M'){ 
        tso$climateInterpretation1_variable <- 'P-E'
      }
    }
    lipdData[[var]][[ts]] <- tso
  }
}
for (name in metadata){
  print(paste("Revised",name,":",list(unique(pullTsVariable(lipdData$HC,name)))))
}
```

    ## [1] "Revised climateInterpretation1_seasonalityGeneral : c(\"Annual\", \"Summer\", \"Winter\", \"Summer+\", \"Winter+\")"
    ## [1] "Revised climateInterpretation1_variable : c(\"P-E\", \"P\")"

``` r
#
```

#### Add chronology metadata

``` r
for (var in c('HC')){
  for (ts in 1:length(lipdData[[var]])){
    #
    #Load basic information for each record
    #
    tso     <- lipdData[[var]][[ts]]
    Dselect <- D_hc[[tso$dataSetName]]
    n_chron <- length(Dselect[["chronData"]][[1]][["measurementTable"]])
    n_paleo <- max(length(Dselect[["paleoData"]]),length(Dselect[["paleoData"]][[1]][["measurementTable"]]))
    #
    #
    if (n_chron == 0){                                         
      i_chron <- NA
    } else if (n_chron*n_paleo == 1){                          
      i_chron <- 1
    } else if (grepl("Composite",tso$paleoData_variableName)){
      offset<-c()
      for (j in 1:n_chron){
        chronAges <- Dselect[["chronData"]][[1]][["measurementTable"]][[j]][["age"]]$values
        offset <- c(offset,max(abs(tso$ageMin-min(chronAges,na.rm=TRUE)),
                               abs(tso$ageMax-max(chronAges,na.rm=TRUE))))
      }
      i_chron <- which(offset==min(offset))
    } else if(n_chron+1 == n_paleo & tso$archiveType=='Speleothem'){
        for (i in 1:n_paleo){
          if (!is.null(Dselect[["paleoData"]][[1]][["measurementTable"]][[i]][[tso$paleoData_variableName]]$TSid)){
            if (Dselect[["paleoData"]][[1]][["measurementTable"]][[i]][[tso$paleoData_variableName]]$TSid == tso$paleoData_TSid){
              i_chron <- i
            }
          }
        }
    } else if (n_chron != n_paleo){      
      offset<-c()
      for (j in 1:n_chron){
        chronAges <- Dselect[["chronData"]][[1]][["measurementTable"]][[j]][["age"]]$values
        offset <- c(offset,max(abs(tso$ageMin-min(chronAges,na.rm=TRUE)),
                               abs(tso$ageMax-max(chronAges,na.rm=TRUE))))
      }
      i_chron <- which(offset==min(offset))
    } else{
      for (i in 1:n_paleo){
        if (!is.null(Dselect[["paleoData"]][[1]][["measurementTable"]][[i]][[tso$paleoData_variableName]]$TSid)){
          if (Dselect[["paleoData"]][[1]][["measurementTable"]][[i]][[tso$paleoData_variableName]]$TSid == tso$paleoData_TSid){
            i_chron <- i
          }
        }
      }
    }
    if (tso$paleoData_TSid %in% c('lcRpbhIeSqLqRxKnBNF','lcRseG41EyZPFn7vBuL','LPD1498ea89','LPD03892251')){i_chron<-NA}
    if (!is.na(i_chron)){
      tso$chronData_table <- Dselect[["chronData"]][[1]][["measurementTable"]][[i_chron]]
      names <- names(tso$chronData_table)[grepl(c('age'),names(tso$chronData_table),ignore.case=TRUE)]
      for (name in c('type','error','min','max','hi','radio','14','lo','comment','use',"up","old","young","std",
                     "reservoir","","low","Rejected","","comment","err","uncertainty","unc")){
        names <- names[which(grepl(name,names,ignore.case=TRUE)==FALSE)]
      }
      ageColName <- NA
      for (name in c("Th230/Th232","Median","calib.14C","14C.raw","14C Age","14C age BP","Cal yr chosen","age14C","14C age (yr BP)","C14 age dated",
                     tail(names,1),"corrected 230Th Age",
                     "Median Year BP",'age','Age','calAge','CalAge','CalibratedAge','Calibrated Age')){
        if (name %in% names(tso$chronData_table)){
          ageColName <- name
        } 
      }
      tso$chronData_ageName <- ageColName
      tso$chronData_ages <- as.numeric(tso$chronData_table[[tso$chronData_ageName]]$values)
      if (grepl("Composite",tso$paleoData_variableName)){
        tso$chronData_ages <- c()
        for (j in 1:n_chron){
          tso$chronData_ages <- c(tso$chronData_ages,as.numeric(Dselect[["chronData"]][[1]][["measurementTable"]][[j]][["age"]]$values))
        }
      }
      if ((length(which(tso$chronData_ages<13000))<=1) | is.na(sum(tso$chronData_ages,na.rm=TRUE)) | (sum(!is.na(tso$chronData_ages))<length(tso$chronData_ages)*0.5)){
        tso$chronData_table             <- NA
        tso$chronData_ageName           <- NA
        tso$chronData_ages              <- NA
        tso$chronData_ages_12k          <- NA
        tso$chronData_agesN_12k         <- NA
        tso$chronData_agesMaxGap_12k    <- NA
        tso$chronData_agesMedianGap_12k <- NA
      }else{
        tso$chronData_ages <- tso$chronData_ages[which(!is.na(tso$chronData_ages))]
        if(mean(tso$chronData_ages,na.rm=TRUE)<0){
          tso$chronData_ages<-tso$chronData_ages*-1 #
        }
        if(grepl("ka",tso$chronData_table[[tso$chronData_ageName]]$units)){
          tso$chronData_ages<-tso$chronData_ages*1000 #d 
        } else if(max(tso$chronData_ages,na.rm=TRUE)<300){
          tso$chronData_ages<-tso$chronData_ages*1000 #d 
        }
        tso$chronData_ages_12k          <- tso$chronData_ages[which(tso$chronData_ages<13000)]
        tso$chronData_agesN_12k         <- length(which(diff(tso$chronData_ages_12k)>0))+1
        tso$chronData_agesMaxGap_12k    <- max(diff(sort(c(tso$ageMin,tso$chronData_ages_12k,tso$ageMax))))
        tso$chronData_agesMedianGap_12k <- median(abs(diff(sort(c(tso$ageMin,tso$chronData_ages_12k,tso$ageMax)))))
      }
    } else{
      tso$chronData_table             <- NA
      tso$chronData_ageName           <- NA
      tso$chronData_ages              <- NA
      tso$chronData_ages_12k          <- NA
      tso$chronData_agesN_12k         <- NA
      tso$chronData_agesMaxGap_12k    <- NA
      tso$chronData_agesMedianGap_12k <- NA
    }
    lipdData[[var]][[ts]] <- tso
  }
}
```

#### Add category metadata and standardize source

``` r
for (var in names(lipdData)){
  for (ts in 1:length(lipdData[[var]])){
    #
    #Load basic information for each record
    #
    tso <- lipdData[[var]][[ts]]
    #
    #Add category information
    #
    if (var == 'HC'){
      archive  <- tso$archiveType
      proxy    <- tso$paleoData_proxy
      unit     <- tso$paleoData_units
      if(is.null(tso$climateInterpretation1_variableDetail)){tso$climateInterpretation1_variableDetail<-'Blank'} 
      if (is.null(proxy) | is.null(archive)){
        tso$Category         <- 'Other'
        tso$CategorySpecific <- 'Other (Not Calibrated)'
      } else if (archive == 'Speleothem'){
        tso$Category           <- 'Speleothem'
        if (proxy == 'd18O' | proxy ==  'd13C'){
          tso$CategorySpecific <- paste(archive,' (','',substring(proxy, 2),')',sep='')
        } else{
          tso$CategorySpecific <- 'Speleothem (Other)'
        }
      } else if (tolower(tso$climateInterpretation1_variableDetail) == 'lakelevel@surface'){
        tso$Category           <- 'Shoreline'
        tso$CategorySpecific   <- 'Shoreline (Lake Level)'
      } else if (archive == 'GlacierIce'){
        tso$Category           <- 'Glacier Ice'
        tso$CategorySpecific   <- 'Glacier Ice (Accumulation)'
      } else if (archive == 'LakeSediment' & proxy == 'd18O'){
        tso$Category           <- 'Lake Sediment (18O)'
        tso$CategorySpecific   <- 'Lake Sediment (18O)'
      } else if (proxy == 'dDwax'){
        tso$Category           <- 'Leaf Wax'
        tso$CategorySpecific   <- 'Leaf Wax (D)'
      } else if (proxy == 'pollen'){
        tso$Category           <- 'Pollen'
        if (is.null(unit)){
          tso$CategorySpecific <- 'Pollen (Not Calibrated)'
        } else if (grepl('mm/',unit)){ 
          tso$CategorySpecific <- 'Pollen (Calibrated)'
        } else {
          tso$CategorySpecific <- 'Pollen (Not Calibrated)'
        }
      } else {
        tso$Category           <- 'Other'
        if (is.null(unit)){
          tso$CategorySpecific <- 'Other (Not Calibrated)'
        } else if (grepl('mm/',unit)){ 
          tso$CategorySpecific <- 'Other (Calibrated)'
        } else {
          tso$CategorySpecific <- 'Other (Not Calibrated)'
        }
      }
    } else{
      tso$Category         <- tso$paleoData_proxyGeneral
      tso$CategorySpecific <- tso$paleoData_proxyGeneral
    }
    #
    #Add source
    #
    if (var == 'HC'){
      if (is.null(tso$createdBy)){tso$createdBy <- ''}
      if (is.null(tso$originalDataUrl)){tso$originalDataUrl <- ''}
      if (is.null(tso$calibration_method)){tso$calibration_method <- ''}
      if (is.null(tso$pub1_doi)){tso$pub1_doi <- ''}
      if (is.null(tso$pub2_doi)){tso$pub2_doi <- ''}
      #
      if (grepl('oxfordLakeStatus2Lipd',tso$createdBy)){
        tso$Source = 'Oxford Lake Level Database'
      }
      else if (grepl('paleoDiver2lipd',tso$createdBy)){
        tso$Source = 'Liefert and Shuman, 2020'
      }
      else if (tso$createdBy =='sisal2lipd'){
        tso$Source = 'SISALv2'
      }
      else if (grepl('LegacyClimate2LiPD',tso$createdBy)){
        tso$Source = 'Legacy Climate v1.0'
      }
      else if (tso$originalDataUrl == 'geochange.er.usgs.gov/midden/'){
        tso$Source = 'wNA'
      }
      else if (grepl('/study/30535',tso$originalDataUrl)){
        tso$Source = 'wNA'
      }
      else if (grepl('10.25921/bnxb-1n90',tso$originalDataUrl)){
        tso$Source = 'Mid-Latitude Holocene'
      }
      else if (grepl('/study/15444',tso$originalDataUrl)){
        tso$Source = 'Arctic Holocene'
      }
      else if (grepl('10.5194/essd-12-2261-2020',tso$originalDataUrl) | (substr(tso$dataSetName,1,2) == 'LS')){
        tso$Source = 'Iso2k'
      }
      else if (grepl('10.25921/4RY2-G808',tso$originalDataUrl) | grepl('/study/27330',tso$originalDataUrl)){
        tso$Source = 'Temp12k'
      } else{tso$Source = 'Other'}
    } else{tso$Source <- 'Temp12k'}
    #
    lipdData[[var]][[ts]] <- tso
  }
}
```

``` r
legacyRMSE <- read.csv("/Volumes/GoogleDrive/My Drive/zResearch/Manuscript/2021_HoloceneHydroclimate/ProxyInfo/LegacyClimateTSidPassQC.csv")
otherUnc   <- read.csv("/Volumes/GoogleDrive/My Drive/zResearch/Manuscript/2021_HoloceneHydroclimate/ProxyInfo/hc_proxy_Unc.csv")

var <- 'HC'
for (ts in 1:length(lipdData[[var]])){
  tso <- lipdData[[var]][[ts]] 
  #SISAL Measurment Unc.
  if(tso$Source=="SISALv2"){ #ts = 290
    Dselect_paleo <- D_hc[[tso$dataSetName]][["paleoData"]][[1]][["measurementTable"]]
    if(substr(tso$paleoData_variableName, 1, 4) %in% c('d18O','d13C') == FALSE){next}
    for (i in length(Dselect_paleo)){ 
      if(!is.null(Dselect_paleo[[i]][[tso$paleoData_variableName]])){
        if(Dselect_paleo[[i]][[tso$paleoData_variableName]]$TSid == tso$paleoData_TSid){
          if(sum(tso$age==Dselect_paleo[[i]]$age$values,na.rm=TRUE) == sum(!is.na(tso$age))){
            #
            unc <-                   Dselect_paleo[[i]][[paste0(substr(tso$paleoData_variableName, 1, 4),"Precision")]]
            if (is.null(unc)){unc <- Dselect_paleo[[i]][[paste0(substr(tso$paleoData_variableName, 1, 4),"PrecisionComposite")]]}
            
            tso$paleoData_valuesUnc_TSid        <-unc$TSid
            tso$paleoData_valuesUnc_Description <- "measurment precision"
            tso$paleoData_valuesUnc             <- median(unc$values)
            tso$paleoData_valuesMax             <- tso$paleoData_values + unc$values
            tso$paleoData_valuesMin             <- tso$paleoData_values - unc$values
            #tso$paleoData_valuesAgeMax <- tso$age + Dselect_paleo[[i]]$ageBchronUncertaintyLow$values
            #tso$paleoData_valuesAgeMin <- tso$age - Dselect_paleo[[i]]$ageBchronUncertaintyLow$values
            #
          } else{print(paste("error:",tso$paleoData_TSid))}
        }
      }
    }
  } else if (tso$Source == "Legacy Climate v1.0"){
    tsoUnc <- TS_hc_all[[which(pullTsVariable(TS_hc_all,"paleoData_TSid")==legacyRMSE[which(legacyRMSE$TSid==tso$paleoData_TSid),]$MeasUncertaintyTSid)]]
    if(sum(tso$age==tsoUnc$age) == length(tso$age)){
      tso$paleoData_valuesUnc_TSid        <- tsoUnc$TSid
      tso$paleoData_valuesUnc_Description <- "RMSE"
      tso$paleoData_valuesUnc             <- legacyRMSE[which(legacyRMSE$TSid==tso$paleoData_TSid),]$RMSE
      tso$paleoData_valuesMax             <- tso$paleoData_values + tsoUnc$paleoData_values
      tso$paleoData_valuesMin             <- tso$paleoData_values - tsoUnc$paleoData_values
    } else{print(paste("error:",tso$paleoData_TSid))}
  } else if (tso$paleoData_TSid %in% otherUnc$tsid){
    df <- otherUnc %>% filter(tsid==tso$paleoData_TSid)
    if (nrow(df) == 1){
      if (is.na(df$unc)){
        tso$paleoData_valuesUnc_TSid        <- NA
        tso$paleoData_valuesUnc_Description <- NA
        tso$paleoData_valuesUnc             <- NA
      } else{
        tso$paleoData_valuesUnc_TSid        <- NA
        tso$paleoData_valuesUnc_Description <- df$description
        tso$paleoData_valuesUnc             <- df$unc
        tso$paleoData_valuesMax             <- tso$paleoData_values + df$unc
        tso$paleoData_valuesMin             <- tso$paleoData_values - df$unc 
      }
    } else if (nrow(df) > 1){
      if(sum(tso$age==df$age,na.rm=TRUE) == sum(!is.na(tso$age))){
        tso$paleoData_valuesUnc_TSid        <- NA
        tso$paleoData_valuesUnc_Description <- df$description
        tso$paleoData_valuesUnc             <- median(df$unc,na.rm=TRUE)
        if (df$type[1]=='abs'){
          tso$paleoData_valuesMax           <- df$max
          tso$paleoData_valuesMin           <- df$min
        } else{
          tso$paleoData_valuesMax           <- tso$paleoData_values + df$max
          tso$paleoData_valuesMin           <- tso$paleoData_values - df$min
        }
      } else{
        print(tso$paleoData_TSid)
        print(ts)
      }
    }
  }
  lipdData[[var]][[ts]] <- tso
}
```

    ## [1] "error: S2LRbRVYOu2hWu"

#### Save LiPD timeseries as .rds file

``` r
print(paste("Temp:",length(lipdData$T)))  #1321
```

    ## [1] "Temp: 1321"

``` r
print(paste("HC:",  length(lipdData$HC))) #819
```

    ## [1] "HC: 819"

``` r
if(save){saveRDS(lipdData, file.path(wd,'Data','Proxy','lipdData.rds'))}
```

#### Create summary dataframe for HC and T proxies

``` r
for (var in names(lipdData)){
  lipdTSO <- lipdData[[var]]
  proxyDf <- tibble(dataset       = pullTsVariable(lipdTSO,'dataSetName'),
                    tsid          = pullTsVariable(lipdTSO,'paleoData_TSid'),
                    longitude     = pullTsVariable(lipdTSO,'geo_longitude'),
                    latitude      = pullTsVariable(lipdTSO,'geo_latitude'),
                    ipccReg       = pullTsVariable(lipdTSO,'geo_ipccRegion'),
                    archive       = pullTsVariable(lipdTSO,'archiveType'),
                    proxy         = pullTsVariable(lipdTSO,'paleoData_proxy'),
                    Category      = pullTsVariable(lipdTSO,'Category'),
                    CategorySpec  = pullTsVariable(lipdTSO,'CategorySpecific'),
                    minAge        = pullTsVariable(lipdTSO,'ageMin'),
                    maxAge        = pullTsVariable(lipdTSO,'ageMax'),
                    ageRange      = pullTsVariable(lipdTSO,'ageRange'),
                    ageRes        = pullTsVariable(lipdTSO,'ageRes'),
                    ageResPlus    = pullTsVariable(lipdTSO,'ageResPlus'),
                    season        = pullTsVariable(lipdTSO,'climateInterpretation1_seasonalityGeneral'),
                    climInterp    = pullTsVariable(lipdTSO,'climateInterpretation1_variable'),
                    source        = pullTsVariable(lipdTSO,'Source'),
                    direction     = pullTsVariable(lipdTSO,'climateInterpretation1_interpDirection'),
                    ka_0.5        = rep(NA, length(lipdTSO)),
                    ka_4          = rep(NA, length(lipdTSO)),
                    ka_6          = rep(NA, length(lipdTSO)),
                    ka_8          = rep(NA, length(lipdTSO)),
                    ka_10         = rep(NA, length(lipdTSO)),
                    maxValAge     = rep(NA, length(lipdTSO)),
                    minValAge     = rep(NA, length(lipdTSO)),
  ) 
  #
  if (var=='HC'){
      proxyDf$ageCtrlN      = pullTsVariable(lipdTSO,'chronData_agesN_12k')
      proxyDf$ageCtrlMax    = pullTsVariable(lipdTSO,'chronData_agesMaxGap_12k')
      proxyDf$ageCtrlMedian = pullTsVariable(lipdTSO,'chronData_agesMedianGap_12k')
  }
  #Calculate timeslice means 
  for (tso in lipdTSO){
    i = which(proxyDf$tsid == tso$paleoData_TSid)
    vals = tso$paleoData_values[which(between(tso$age,0,12000))]
    ages =              tso$age[which(between(tso$age,0,12000))]
    for (ka in c(0.5,seq(4,10,2))){
      bounds <- which(between(ages, 1000*ka-500, 1000*ka+500))
      proxyDf[i,paste('ka',ka,sep='_')] <- round(mean(vals[bounds],na.rm=TRUE),3)
    }
    if (!is.na(proxyDf[i,'direction'])){
      if (proxyDf[i,'direction']=='negative'){vals  <- vals*-1
      }
    }
    proxyDf[i,'maxValAge'] <- mean(ages[which(vals==max(vals,na.rm=TRUE))])
    proxyDf[i,'minValAge'] <- mean(ages[which(vals==min(vals,na.rm=TRUE))])
  }
  write.csv(proxyDf,file=file.path(wd,'Data','Proxy',paste('proxyMetadata_',var,'.csv',sep='')))
}
```
