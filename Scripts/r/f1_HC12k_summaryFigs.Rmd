---
goal: Plot age metadata to summarize holocene hydroclimate dataset
input: rdata for Temp12k and HC12k ts; refRegions
output: 4 figures (histogram of record length and resolution, graph of ts availability, and plot of number of records in each region)
author: chris hancock
---

###Settings in script
```{r}
#Set up directories and names
githubDir <- getwd()
#
```

###Load packages 
```{r}
library(cowplot)
library(geoChronR)
library(ggplot2)
library(lipdR)
library(maptools)
library(proj4)
library(RColorBrewer)
library(rworldmap)
library(scales)
library(sp)
library(tidyverse)
```

###Input Data
```{r, warning=FALSE}
lipdData <- readRDS(file=file.path(githubDir,'Data','LiPD','lipdData.rds'))

PROJ       <- "+proj=robin +lon_0=0 +x_0=0 +y_0=0 +ellps=WGS84 +datum=WGS84 +units=m +no_defs"
PROJorig   <- "+proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs"
refregions <- readShapePoly(file.path(githubDir,'Data','IPCC_refRegions','IPCC-WGI-reference-regions-v4.shp'),
                            proj4string=CRS(PROJorig))
refregions <-  spTransform(refregions, CRSobj = PROJ)

countries  <- getMap("less islands")
countries  <- spTransform(countries,  CRSobj = PROJ)

climVar    <- 'HC'
lipdTSO    <- lipdData[[climVar]]
```

###Add information about proxy categories
```{r}
climVar <- 'HC'
lipdTSO <- lipdData[[climVar]]
proxyMetaData <- tibble(dataset        = pullTsVariable(lipdTSO,'dataSetName'),
                        tsid           = pullTsVariable(lipdTSO,'paleoData_TSid'),
                        longitude      = pullTsVariable(lipdTSO,'geo_longitude'),
                        latitude       = pullTsVariable(lipdTSO,'geo_latitude'),
                        ipccReg        = pullTsVariable(lipdTSO,'geo_ipccRegion'),
                        Category       = pullTsVariable(lipdTSO,'Category'),
                        CategorySpec   = pullTsVariable(lipdTSO,'CategorySpecific'),
                        recordRange    = pullTsVariable(lipdTSO,'ageRange'),
                        recordRes      = pullTsVariable(lipdTSO,'ageRes'),
                        recordResPlus  = pullTsVariable(lipdTSO,'ageResPlus'))
##############################
###Create list of color information
plotVals <- vector(mode='list')
plotVals$general  <- vector(mode='list')
plotVals$specific <- vector(mode='list')

plotVals$general$names  <- sort(unique(proxyMetaData$Category))
plotVals$general$colors <- c("powder blue","corn flower blue",
                             "dark blue","dark orchid","grey",
                             "forest green","firebrick")
plotVals$general$shapes <- c(12,21,15,5,13,14,11)

plotVals$specific$names <- sort(unique(proxyMetaData$CategorySpec))
plotVals$specific$colors<- c("powder blue","corn flower blue",
                             "dark blue","dark orchid","grey40","grey",
                            "forest green","yellowgreen","lightcoral","firebrick","darkorange")
plotVals$specific$shapes<- c(12,21,15,5,6,13,14,1,23,11,17)

```

Plot a histagram showing the median time difference between Holocene ages
```{r}
plotRes <- ggplot(proxyMetaData)+
  geom_vline(xintercept=median(proxyMetaData$recordRes),size=1.1) +
  geom_vline(xintercept=mean(proxyMetaData$recordRes),size=1.1,linetype=2) +
  geom_histogram(aes(recordRes,fill=Category),color='Black',alpha=0.7,binwidth = 30) +
  scale_fill_manual(values=plotVals$general$colors) +
  scale_x_continuous(name="Median Sample Resolution Over the Holocene (binwidth = 30)" ,
                     limits=c(0,1250), expand=c(0,0), breaks=seq(0,1250,150)) +
  scale_y_continuous(name="Count of Records", oob=scales::squish, limits=c(0,100), expand=c(0,0))+
  theme_bw()+
  theme(text = element_text(family='sans',size=8),
        legend.title = element_blank(),legend.position = c(0.5,0.7))
plotRes
##############################
plotResPlus <- ggplot(proxyMetaData)+
  geom_vline(xintercept=median(proxyMetaData$recordResPlus),size=1.1) +
  geom_vline(xintercept=mean(proxyMetaData$recordResPlus),size=1.1,linetype=2) +
  geom_histogram(aes(recordResPlus,fill=Category),color='Black',alpha=0.7,binwidth = 30) +
  scale_fill_manual(values=plotVals$general$colors) +
  scale_x_continuous(name = "Median Sample Resolution Over the Holocene (binwidth = 30)" ,
                     limits=c(0,3000), expand=c(0,0), breaks=seq(0,1250,150)) +
  scale_y_continuous(name="Count of Records", oob=scales::squish, limits=c(0,100), expand=c(0,0))+
  theme_bw()+
  theme(text = element_text(family='sans',size=8),
        legend.title = element_blank(), legend.position = c(0.5,0.7))
plotResPlus
```


Plot a histagram based on record length over the Holocene
```{r}
plotRange <- ggplot(proxyMetaData)+
  geom_vline(xintercept=median(proxyMetaData$recordRange),size=1.1) +
  geom_vline(xintercept=mean(proxyMetaData$recordRange),size=1.1,linetype=2) +
  geom_histogram(aes(recordRange,fill=Category),color='Black',alpha=0.7,binwidth = 300) +
  scale_fill_manual(values=plotVals$general$colors) +
  scale_x_continuous(name = "Record Length Over the Holocene (binwidth = 300)",
                     limits=c(3000,12000),expand=c(0,0),breaks=seq(3000,12000,1200)) +
  scale_y_continuous(name = "Count of Records",oob=scales::squish,limits=c(0,80),expand=c(0,0)) +
  theme_bw()+
  theme(text = element_text(family='sans',size=8),
        legend.title = element_blank(), legend.position = c(0.5,0.7))
plotRange
```

```{r}
#Plot a figure showiang temporal variability over the Holocene (using geochronR)
plotTimeData <- plotTimeAvailabilityTs(lipdTSO,age.range = c(0,12000),step=200,group='Category')
plotTime <- ggplot(plotTimeData$data,aes(yvec,value))+
  geom_area(alpha=0.7,aes(fill=group),color='Black')+
  scale_fill_manual(values=plotVals$general$colors) +
  scale_x_reverse(name = "Age (yr BP)", limits=c(12000,0),expand=c(0,0),
                  n.breaks=7,sec.axis = sec_axis(~.,labels=NULL))+
  scale_y_continuous(name = "Number of Records",limits=c(0,length(lipdTSO)),expand=c(0,0),
                     labels=seq(0,length(lipdTSO),100), breaks=seq(0,length(lipdTSO),100))+
  theme_bw()+
  theme(text = element_text(family='sans',size=8),
        legend.title = element_blank())

plotTime
```


```{r}
proxyDataPrj   <- SpatialPointsDataFrame(proxyMetaData[,c("longitude", "latitude")], proxyMetaData, proj4string=CRS(PROJorig))
proxyDataPrj   <- spTransform(proxyDataPrj, CRSobj = PROJ)
refrenceSubset <- subset(refregions, Acronym %in% proxyMetaData$ipccReg)

dataTable <- fortify(refrenceSubset)
dataTable$Count     <- NA
dataTable$CountName <- NA
dataTable$Region    <- NA

#Set Breaks and color scheme with lowest group as grey
figBreaks <- c(5,10,20,30,40,60,80)
figlabels <- c(paste("<",figBreaks[1]+1),
               paste(as.character(figBreaks[-length(figBreaks)]+1),"-",
                     as.character(figBreaks[-1])),
               paste(">",figBreaks[length(figBreaks)]))
figPalette <- c("#CCCCCC",brewer.pal(n = 7, name = "YlOrBr"))

for (region in list(levels(refrenceSubset@data[["Acronym"]]))[[1]]){
  i = which(refregions@data[["Acronym"]]==region)
  count <- length(which(proxyMetaData$ipccReg==region))
  if (count == 0){         countName <- NA
  } else if (count <= figBreaks[1]){ countName <- 0
  } else if (count <= figBreaks[2]){ countName <- 1
  } else if (count <= figBreaks[3]){ countName <- 2
  } else if (count <= figBreaks[4]){ countName <- 3
  } else if (count <= figBreaks[5]){ countName <- 4
  } else if (count <= figBreaks[6]){ countName <- 5
  } else if (count <= figBreaks[7]){ countName <- 6
  } else {countName <- 7}
  dataTable$Count[which(dataTable$id==as.character(i-1))]     <- count
  dataTable$CountName[which(dataTable$id==as.character(i-1))] <- countName
  dataTable$Region[which(dataTable$id==as.character(i-1))]    <-region
}

```

#Map proxy data with IPCC regions
```{r}
basemap <- ggplot() +
  #Set Border around plot - probably not the best way to do this
  borders(aggregate(refregions, FUN=length), fill=NA, colour='black', size=2) +
  geom_map(data=refregions, map=fortify(refregions),
           aes(x=long, y=lat, group=group, map_id=id), fill="white", colour="white", size=1)+
  #Add Country data (basemap)
  geom_map(data=countries, map=fortify(countries),
           aes(x=long, y=lat, group=group, map_id=id), fill = "grey80",color="grey90",size=0.2) +
  coord_fixed(1) + 
  theme_void() 

##############################
#Plot Figure 1 proxy type for each site
proxyMapSites <- basemap +
  geom_map(data=refrenceSubset, map=dataTable, alpha=0.75, size=0.5, color='black' , 
           aes(x=long, y=lat, group=group, map_id=id),fill=NA)

for (i in 1:length(plotVals$specific$names)){
  proxyMapSites <- proxyMapSites +
    geom_star(data=(as.data.frame(proxyDataPrj) %>% filter(CategorySpec==plotVals$specific$names[i])),
               aes(x=longitude.1 , y=latitude.1), size=1.5,color='Black',alpha=0.7,starstroke=0.3,
               starshape=plotVals$specific$shapes[i], fill=plotVals$specific$colors[i])
}
proxyMapSites

##############################
#Plot Figure 2 count by regions
proxyMapRegions <- basemap + 
  #Add refrence regions boundaries
  geom_map(data=refrenceSubset, map=dataTable, alpha=0.75, size=0.5, color='black' , 
           aes(x=long, y=lat, group=group, map_id=id,fill=as.factor(dataTable$CountName))) +
  scale_fill_manual(values=figPalette,labels=figlabels)+
  #Add proxy sites
  geom_point(data=as.data.frame(proxyDataPrj), aes(x=longitude.1 , y=latitude.1), shape=1,size=0.8) +
  #Format Legend
  theme(legend.position = c(0.5,-0.01),
        legend.direction = "horizontal",
        legend.title=element_blank(),
        legend.background=element_rect(colour='black',size=0.4),
        legend.margin=margin(t = 1, r = 1, b = 3, l = -4.5, unit = "pt"),
        legend.key.width  = (unit(35, 'pt')),
        legend.key.height = (unit(5, 'pt')),
        legend.text = element_text(family='sans',size=8))

proxyMapRegions
```

Save Figures
```{r}
ggsave(plot=plotRes, width = 6.5, height = 4, dpi = 600,
       filename = file.path(githubDir,"Figures","PlotProxyAgeRes.png"))
ggsave(plot=plotResPlus, width = 6.5, height = 4, dpi = 600,
       filename = file.path(githubDir,"Figures","PlotProxyAgeResPlus.png"))
ggsave(plot=plotRange, width = 6.5, height = 4, dpi = 600,
       filename = file.path(githubDir,"Figures","PlotProxyAgeRange.png"))
ggsave(plot=plotTime, width = 6, height = 2.5, dpi = 600,
       filename = file.path(githubDir,"Figures","PlotTimeAvailability.png"))
ggsave(plot=proxyMapSites, width = 6, height = (6/1.97+0.5), dpi = 600,
       filename = file.path(githubDir,"Figures",paste('PlotProxyTypeRegion_',climVar,'.png',sep='')))
ggsave(plot=proxyMapRegions, width = 6, height = (6/1.97+0.5), dpi = 600,
       filename = file.path(githubDir,"Figures",paste('PlotCountByRegion_',climVar,'.png',sep='')))
```







```{r}
fTS <- lipdTSO[which(proxyMetaData$ipccReg=='SAS')]
tidyData <- tidyTs(fTS,age.var = "age")
plot.df <- tidyData %>% 
  filter(between(age,0,12000)) %>% #only years from 1600 to 2000
  group_by(paleoData_TSid) %>% #group by column
  arrange(geo_latitude) #and sort by archiveType
plotTimeseriesStack(plot.df,time.var='age',invert.var='climateInterpretation1_interpDirection')

```
