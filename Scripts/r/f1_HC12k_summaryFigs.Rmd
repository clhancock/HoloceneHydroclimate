---
goal: Plot age metadata to summarize holocene hydroclimate dataset
input: rdata for Temp12k and HC12k ts; refRegions
output: 4 figures (histogram of record length and resolution, graph of ts availability, and plot of number of records in each region)
author: chris hancock
---

###Settings in script
```{r}
#Set up directories and names
#dataDir   <- '/Volumes/GoogleDrive/My Drive/zResearch/Data/'
githubDir <- '/Volumes/GoogleDrive/My Drive/zResearch/HoloceneHydroclimate'
#dataDir   <- 'G:/My Drive/zResearch/Data/'
githubDir <- 'G:/My Drive/zResearch/HoloceneHydroclimate/'
setwd(githubDir)
#
```

###Load packages 
```{r}
library(cowplot)
library(geoChronR)
library(ggplot2)
library(lipdR)
library(maptools)
library(proj4)
library(RColorBrewer)
library(rworldmap)
library(scales)
library(sp)
library(tidyverse)
```
###Input Data
```{r}
lipdData <- readRDS(file=file.path(githubDir,'Data','LiPD','lipdData.rds'))
Save <- TRUE

PROJ <- "+proj=robin +lon_0=0 +x_0=0 +y_0=0 +ellps=WGS84 +datum=WGS84 +units=m +no_defs"
PROJorig <- "+proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs"
refregions <- readShapePoly(file.path(githubDir,'Data','IPCC_refRegions','IPCC-WGI-reference-regions-v4.shp'),
                            proj4string=CRS(PROJorig))
refregions <-  spTransform(refregions, CRSobj = PROJ)

countries  <- getMap("less islands")
countries  <-  spTransform(countries,  CRSobj = PROJ)

climVar <- 'HC'
lipdTSO <- lipdData[[climVar]]
```


###Add information about proxy categories
```{r}
climVar <- 'HC'
lipdTSO <- lipdData[[climVar]]
proxyMetaData <- tibble(dataset        = pullTsVariable(lipdTSO,'dataSetName'),
                        tsid           = pullTsVariable(lipdTSO,'paleoData_TSid'),
                        longitude      = pullTsVariable(lipdTSO,'geo_longitude'),
                        latitude       = pullTsVariable(lipdTSO,'geo_latitude'),
                        ipccReg        = pullTsVariable(lipdTSO,'geo_ipccRegion'),
                        Category       = pullTsVariable(lipdTSO,'Category'),
                        CategorySpec   = pullTsVariable(lipdTSO,'CategorySpecific'),
                        recordRange    = pullTsVariable(lipdTSO,'ageRange'),
                        recordRes      = pullTsVariable(lipdTSO,'ageRes'),
                        recordResPlus  = pullTsVariable(lipdTSO,'ageResPlus'))
```

Plot a histagram showing the median time difference between Holocene ages
```{r}
plotRes <- ggplot(proxyMetaData)+
  geom_histogram(aes(recordRes,fill=Category),color='Black',alpha=0.7,binwidth = 30) +
  scale_fill_manual(values	=c("powder blue","corn flower blue","dark blue","dark orchid","grey","forest green","firebrick"))+
  scale_x_continuous(name = "Median Sample Resolution Over the Holocene (binwidth = 30)" ,
                     limits=c(0,1250),
                     expand=c(0,0),
                     breaks=seq(0,1250,150)) +
  scale_y_continuous(name = "Count of Records",oob=scales::squish,
                     limits=c(0,100),
                     expand=c(0,0))+
  theme_bw()+
  theme(text = element_text(family='sans',size=8),
        legend.title = element_blank(),
        legend.position = c(0.5,0.7))
plotRes

plotResPlus <- ggplot(proxyMetaData)+
  geom_histogram(aes(recordResPlus,fill=Category),color='Black',alpha=0.7,binwidth = 30) +
  scale_fill_manual(values	=c("powder blue","corn flower blue","dark blue","dark orchid","grey","forest green","firebrick"))+
  scale_x_continuous(name = "Median Sample Resolution Over the Holocene (binwidth = 30)" ,
                     limits=c(0,3000),
                     expand=c(0,0),
                     breaks=seq(0,1250,150)) +
  scale_y_continuous(name = "Count of Records",oob=scales::squish,
                     limits=c(0,100),
                     expand=c(0,0))+
  theme_bw()+
  theme(text = element_text(family='sans',size=8),
        legend.title = element_blank(),
        legend.position = c(0.5,0.7))
plotResPlus
```



Plot a histagram based on record length over the Holocene
```{r}
plotRange <- ggplot(proxyMetaData)+
  geom_histogram(aes(recordRange,fill=Category),color='Black',alpha=0.7,binwidth = 300) +
  scale_fill_manual(values	=c("powder blue","corn flower blue","dark blue","dark orchid","grey","forest green","firebrick"))+
  scale_x_continuous(name = "Record Length Over the Holocene (binwidth = 300)",
                     limits=c(3000,12000),
                     expand=c(0,0),
                     breaks=seq(3000,12000,1200)) +
  scale_y_continuous(name = "Count of Records",oob=scales::squish,
                     limits=c(0,80),
                     expand=c(0,0)) +
  theme_bw()+
  theme(text = element_text(family='sans',size=8),
        legend.title = element_blank(),
        legend.position = c(0.5,0.7))
plotRange
```

```{r}
colorVals <- sort(unique(pullTsVariable(lipdTSO,'Category')))
colorVals <- str_replace(colorVals,"Glacier Ice","powder blue")
colorVals <- str_replace(colorVals,"Lake Deposits","corn flower blue")
colorVals <- str_replace(colorVals,"Lake Sediment d18O","dark blue")
colorVals <- str_replace(colorVals,"Leaf Wax dD","dark orchid")
colorVals <- str_replace(colorVals,"Other","grey")
colorVals <- str_replace(colorVals,"Pollen","forest green")
colorVals <- str_replace(colorVals,"Speleothem" ,"firebrick")
#Plot a figure showiang temporal variability over the Holocene (using geochronR)
plotTimeData <- plotTimeAvailabilityTs(lipdTSO,age.range = c(0,12000),step=200,
                                       age.var="age", group='Category')
plotTime <- ggplot(plotTimeData$data,aes(yvec,value))+
  geom_area(alpha=0.7,aes(fill=group),color='Black')+
  scale_fill_manual(values	= colorVals)+
  scale_x_reverse(name = "Age (yr BP)",
                  limits=c(12000,0),
                  expand=c(0,0),
                  n.breaks=7,
                  sec.axis = sec_axis(~.,labels=NULL))+
  scale_y_continuous(name = "Number of Records",
                     limits=c(0,length(lipdTSO)),
                     expand=c(0,0),
                     labels=seq(0,length(lipdTSO),100),
                     breaks=seq(0,length(lipdTSO),100))+
  theme_bw()+
  theme(text = element_text(family='sans',size=8),
        legend.title = element_blank())

plotTime
```


```{r}


proxyDataPrj <- SpatialPointsDataFrame(proxyMetaData[,c("longitude", "latitude")], 
                                       proxyMetaData, 
                                       proj4string=CRS(PROJorig))

proxyDataPrj   <- spTransform(proxyDataPrj, CRSobj = PROJ)
refrenceSubset <- subset(refregions, Acronym %in% proxyMetaData$ipccReg)

dataTable <- fortify(refrenceSubset)
dataTable$Count     <- NA
dataTable$CountName <- NA
dataTable$Region    <- NA

#Set Breaks and color scheme with lowest group as grey
figBreaks <- c(5,10,20,30,40,60,80)
figlabels <- c(paste("<",figBreaks[1]+1),
               paste(as.character(figBreaks[-length(figBreaks)]+1),"-",
                     as.character(figBreaks[-1])),
               paste(">",figBreaks[length(figBreaks)]))
figPalette <- c("#CCCCCC",brewer.pal(n = 7, name = "YlOrBr"))

for (region in list(levels(refrenceSubset@data[["Acronym"]]))[[1]]){
  i = which(refregions@data[["Acronym"]]==region)
  count <- length(which(proxyMetaData$ipccReg==region))
  if (count == 0){         countName <- NA
  } else if (count <= figBreaks[1]){ countName <- 0
  } else if (count <= figBreaks[2]){ countName <- 1
  } else if (count <= figBreaks[3]){ countName <- 2
  } else if (count <= figBreaks[4]){ countName <- 3
  } else if (count <= figBreaks[5]){ countName <- 4
  } else if (count <= figBreaks[6]){ countName <- 5
  } else if (count <= figBreaks[7]){ countName <- 6
  } else {countName <- 7}
  dataTable$Count[which(dataTable$id==as.character(i-1))]     <- count
  dataTable$CountName[which(dataTable$id==as.character(i-1))] <- countName
  dataTable$Region[which(dataTable$id==as.character(i-1))]    <-region
}

```

```{r}
proxyMap <- ggplot() +
  #Set Border around plot - probably not the best way to do this
  borders(aggregate(refregions, FUN=length), fill=NA, colour='black', size=2) +
  geom_map(data=refregions, map=fortify(refregions),
           aes(x=long, y=lat, group=group, map_id=id), fill="white", colour="white", size=1)+
  #Add Country data (basemap)
  geom_map(data=countries, map=fortify(countries),
           aes(x=long, y=lat, group=group, map_id=id), fill = "grey60",color="grey90",size=0.2) +
  #Add refrence regions boundaries
  geom_map(data = refrenceSubset, map = dataTable, aes(x=long, y=lat, group=group, map_id=id,
                                               fill=as.factor(dataTable$CountName)),alpha=0.75,size=0.5,color='black') +
  geom_point(data=as.data.frame(proxyDataPrj), aes(x=longitude.1 , y=latitude.1), shape=1,size=0.8) +
  coord_fixed(1)+ theme_void() +
  scale_fill_manual(values=figPalette,labels=figlabels)+
  theme(legend.position = c(0.5,-0.01),
        legend.direction = "horizontal",
        legend.title=element_blank(),
        legend.background=element_rect(colour='black',size=0.4),
        legend.margin=margin(t = 1, r = 1, b = 3, l = -4.5, unit = "pt"),
        legend.key.width  = (unit(35, 'pt')),
        legend.key.height = (unit(5, 'pt')),
        legend.text = element_text(family='sans',size=8))

proxyMap
```


Save Figures
```{r}
ggsave(plot=plotRes, width = 6.5, height = 4, dpi = 400,
       filename = paste(githubDir,"/Figures/PlotProxyAgeRes.png",sep=''))
ggsave(plot=plotResPlus, width = 6.5, height = 4, dpi = 400,
       filename = paste(githubDir,"/Figures/PlotProxyAgeResPlus.png",sep=''))
ggsave(plot=plotRange, width = 6.5, height = 4, dpi = 400,
       filename = paste(githubDir,"/Figures/PlotProxyAgeRange.png",sep=''))
ggsave(plot=plotTime, width = 6, height = 2.5, dpi = 400,
       filename = paste(githubDir,"/Figures/PlotTimeAvailability.png",sep=''))
ggsave(paste('countByRegion_',climVar,'.png',sep=''),proxyMap,
       path=paste(githubDir,'Figures/',sep=''),width=6,height=(6/1.97+0.5),dpi = 600,device='png')
```












EVERYTHING BELOW IS WORK IN PROGRESS





```{r}

binres <- 100
stdAgeRange <- c(0,12000)
binvec <- seq(0,12000,binres)

regionDraw  <- vector(mode='list')
for (region in c('monsoon','mid_Lat')){
  if (region == 'monsoon'){
    regionList <- c('SEA','EAS','TIB','SAS','WCA','SAH','NEAF','SEAF','SCA')
  } else if (region == 'mid_Lat'){
    regionList <- c('ESB','WSAF','NWS','WNA','CNA','ENA','GIC')
  }
  proxyDataSelect <- clusterGroups[which(proxyData$Acronym %in% regionList),]
  ffTS <- fTS[which(pullTsVariable(fTS,"paleoData_TSid") %in% proxyDataSelect$TSid)]
  m <- matrix(nrow=length(seq(0,12000,binres)),ncol=length(ffTS))
  for (i in 1:length(ffTS)){
    z <- spreadPaleoData(ffTS[[i]]$age,ffTS[[i]]$paleoData_values,
                         binres,median(diff(ffTS[[i]]$age)))
    zz <- rep(NA,length(seq(0,12000,binres)))
    zz[which(binvec >= min(z$spreadAge) & binvec <= max(z$spreadAge))] <- z$spreadVal
    idx <- which(binvec >= min(stdAgeRange) & binvec <= max(stdAgeRange))
    zz <- (zz - mean(zz[idx],na.rm=TRUE)) / sd(zz[idx],na.rm=TRUE) 
    if (ffTS[[i]]$climateInterpretation1_interpDirection == "negative"){
      zz <- zz*-1
    }
    m[,i] <- zz 
  }
  m2 <- as.tibble(m) %>%
      summarise(dry1 = rowSums(m < 0  & m >= -1, na.rm=TRUE),
                dry2 = rowSums(m < -1 & m >= -2, na.rm=TRUE),
                dry3 = rowSums(m < -2,           na.rm=TRUE),
                wet1 = rowSums(m > 0  & m >= 1,  na.rm=TRUE),
                wet2 = rowSums(m > 1  & m >= 2,  na.rm=TRUE),
                wet3 = rowSums(m > 2,            na.rm=TRUE))
  m3 <- as.tibble(t(apply(m2,1, function(x) x/sum(x))))
  pctCat <- data.frame(timeVals = rep(binvec,3),
                       wetVals  = c(m3$wet1,m3$wet2,m3$wet3),
                       dryVals  = c(m3$dry1,m3$dry2,m3$dry3),
                       CatNames = c(rep(1,length(binvec)),
                                    rep(2,length(binvec)),
                                    rep(3,length(binvec))))
  regionDraw[[region]] <- ggplot(pctCat)+
    geom_density(aes(x=timeVals,y=wetVals,width=binres,
                 fill=CatNames,show.legend=FALSE))+
    geom_col(aes(x=timeVals,y=dryVals*-1,width=binres,
                 fill=CatNames*-1,show.legend=FALSE))+
    scale_fill_distiller(palette = "BrBG",direction=1) +
    scale_x_reverse(name = "Age (yr BP)",
                    limits=c(12000,0),
                    expand=c(0,0),
                    n.breaks=7)+
    scale_y_continuous(name = "Pct of Records",
                       limits=c(-1,1),
                       expand=c(0,0),
                       breaks=seq(-1,1,0.25))+
    theme_bw() + theme(legend.position = "none") 
  m4<- m3 %>% 
    mutate(dry3=(dry3+dry2+dry1)*-1,
           dry2=(dry2+dry1)*-1,
           dry1=dry1*-1,
           wet3=wet3+wet2+wet1,
           wet2=wet2+wet1)
  
  plt <- ggplot()
  colorVals <- brewer.pal(6, 'BrBG')
  #colorVals <- colorVals[c(3,2,1,4,5,6)]
  colorVals <- colorVals[c(1,2,3,6,5,4)]
  count<-0
  for (var in c('dry3','dry2','dry1','wet3','wet2','wet1')){
    count <- count+1
    plt <- plt + 
      geom_line(data=data.frame(x=binvec,y=predict(loess(binvec~m4[[var]]))),
                           aes(x,y)) +
      geom_area(data=data.frame(spline(binvec,m4[[var]])),
                           aes(x,y),fill=colorVals[count],color='black',alpha=0.8)
  } 
  plt <- plt +
      scale_x_reverse(name = "Age (yr BP)",
                      limits=c(12000,0),
                      expand=c(0,0),
                      n.breaks=7)+
      scale_y_continuous(name = "Pct of Records",
                         limits=c(-1,1),
                         expand=c(0,0),
                         breaks=seq(-1,1,0.25))+
      geom_hline(yintercept=0)+
      theme_bw() + theme(legend.position = "none") 
  regionDraw[[paste(region,'_smooth',sep='')]] <- plt
}

pctWetDry <- ggdraw() + 
  draw_plot(regionDraw[['monsoon_smooth']] , x = 0, y = 0,   width = 1, height = 0.5) + 
  draw_plot(regionDraw[['mid_Lat_smooth']],  x = 0, y = 0.5, width = 1, height = 0.5) 
ggsave(paste('pctWetDry_',climateVariable,'.png',sep=''),pctWetDry,
       path=paste(githubDir,'Figures/',sep=''),width=6,height=4,dpi = 600,device='png')
  
```





```{r}
mapData <- as.data.frame(proxyDataPrj)
mapData <- mapData %>% mutate(categoryShape = case_when(
  CategorySpecific == "Glacier Ice"          ~  '\u25CA',
  CategorySpecific == "Lake Deposits"        ~  '\u25CB',
  CategorySpecific == "Lake Sediment (d18O)" ~  '\U25EF',
  CategorySpecific == "Leaf Wax"             ~  '\u2B20',
  CategorySpecific == "Other (calibrated)"   ~  '\u25A0',
  CategorySpecific == "Other (uncalibrated)" ~  '\u25A0',
  CategorySpecific == "Pollen (calibrated)"  ~  '\U271A',
  CategorySpecific == "Pollen (uncalibrated)"~  '\U2716',
  CategorySpecific == "Speleothem (d18O)"    ~  '\u25B2',
  CategorySpecific == "Speleothem (d13C)"    ~  '\u25BC',
  CategorySpecific == "Speleothem (other)"   ~  '\u25BA'))

mapData <- mapData %>% mutate(categoryColor = case_when(
  CategorySpecific == "Glacier Ice"          ~  '\u25CA',
  CategorySpecific == "Lake Deposits"        ~  '\u25CB',
  CategorySpecific == "Lake Sediment (d18O)" ~  '\U25EF',
  CategorySpecific == "Leaf Wax"             ~  '\u2B20',
  CategorySpecific == "Other (calibrated)"   ~  '\u25A0',
  CategorySpecific == "Other (uncalibrated)" ~  '\u25A0',
  CategorySpecific == "Pollen (calibrated)"  ~  '\U271A',
  CategorySpecific == "Pollen (uncalibrated)"~  '\U2716',
  CategorySpecific == "Speleothem (d18O)"    ~  '\u25B2',
  CategorySpecific == "Speleothem (d13C)"    ~  '\u25BC',
  CategorySpecific == "Speleothem (other)"   ~  '\u25BA'))

#ggplot() +geom_text(data=mapData, aes(x=Lon.1 , y=Lat.1,label=categoryShape),size=4)

```
