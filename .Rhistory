#geom_vline(aes(xintercept = 4.2))+
geom_histogram(aes(x=x,fill=paste0('Duration (median=',median(x),')')),alpha=0.9,binwidth = 100)+
geom_vline(aes(xintercept=median(x)),color='#B34C4C',size=1)+
scale_x_continuous('Duration (years)')+
scale_y_continuous('Count (# of papers)',limits=c(0,15),expand=c(0,0))+
labs(title="Metanalysis: what was the duration of the 4.2 event?")+
scale_fill_manual(values = c("#F08080"))+
theme_bw()+
theme(legend.position = c(0.7,0.923),
legend.title = element_blank(),
legend.background = element_rect(fill='grey99',color='grey80'),
legend.direction = 'horizontal',
text = element_text(size = 15))
plt3
#Plot duration of the 4.2 event
plt3 <- ggplot(data.frame(x=(begs-ends)*1000)) +
#geom_vline(aes(xintercept = 4.2))+
geom_histogram(aes(x=x,fill=paste0('Duration (median=',median(x),')')),alpha=0.9,binwidth = 100)+
geom_vline(aes(xintercept=median(x)),color='#B34C4C',size=1)+
scale_x_continuous('Duration (years)')+
scale_y_continuous('Count (# of papers)',limits=c(0,15),expand=c(0,0))+
labs(title="Metanalysis:\nWhat was the duration of the 4.2 event?")+
scale_fill_manual(values = c("#F08080"))+
theme_bw()+
theme(legend.position = c(0.7,0.923),
legend.title = element_blank(),
legend.background = element_rect(fill='grey99',color='grey80'),
legend.direction = 'horizontal',
text = element_text(size = 15))
plt3
ggsave(file.path(data_dir,'Duration_Hist.png'),dpi = 400, height = 6.5, width = 6, unit = 'in')
plt2 <- ggplot() +
#geom_vline(aes(xintercept = 4.2))+
geom_histogram(aes(x=begs,fill=paste0('Beginning (median=',median(begs),')')),alpha=0.55,binwidth=0.1)+
geom_vline(aes(xintercept=median(begs)),color='darkseagreen4',size=1)+
geom_histogram(aes(x=ends,fill=paste0('End of event (median=',median(ends),')')),alpha=0.55,binwidth=0.1)+
geom_vline(aes(xintercept=median(ends)),color='#4B0082',size=1)+
scale_x_reverse('Age (ka)')+
scale_y_continuous('Count (# of papers)',limits=c(0,22.5),expand=c(0,0))+
labs(title="Metanalysis:\nWhen did the 4.2 ka event occur?")+
scale_fill_manual(values = c("darkseagreen", "#4B0082"))+
theme_bw()+
theme(legend.position = c(0.5,0.923),
legend.title = element_blank(),
legend.background = element_rect(fill='grey99',color='grey80'),
legend.direction = 'horizontal',
text = element_text(size = 15))
plt2
ggsave(file.path(data_dir,'StartEnd_Hist.png'),dpi = 400, height = 6.5, width = 6, unit = 'in')
plt2 <- ggplot() +
#geom_vline(aes(xintercept = 4.2))+
geom_histogram(aes(x=begs,fill=paste0('Beginning (median=',median(begs),')')),alpha=0.55,binwidth=0.1)+
geom_vline(aes(xintercept=median(begs)),color='darkseagreen4',size=1)+
geom_histogram(aes(x=ends,fill=paste0('End of event (median=',median(ends),')')),alpha=0.55,binwidth=0.1)+
geom_vline(aes(xintercept=median(ends)),color='#4B0082',size=1)+
scale_x_reverse('Age (ka)')+
scale_y_continuous('Count (# of papers)',limits=c(0,22.5),expand=c(0,0))+
labs(title="Metanalysis:\nWhen did the 4.2 ka event occur?")+
scale_fill_manual(values = c("darkseagreen", "#4B0082"))+
theme_bw()+
theme(legend.position = c(0.5,0.923),
legend.title = element_blank(),
legend.background = element_rect(fill='grey99',color='grey80'),
legend.direction = 'horizontal',
text = element_text(size = 18))
plt2
ggsave(file.path(data_dir,'StartEnd_Hist.png'),dpi = 400, height = 6.5, width = 6, unit = 'in')
plt2 <- ggplot() +
#geom_vline(aes(xintercept = 4.2))+
geom_histogram(aes(x=begs,fill=paste0('Beginning (median=',median(begs),')')),alpha=0.55,binwidth=0.1)+
geom_vline(aes(xintercept=median(begs)),color='darkseagreen4',size=1)+
geom_histogram(aes(x=ends,fill=paste0('End of event (median=',median(ends),')')),alpha=0.55,binwidth=0.1)+
geom_vline(aes(xintercept=median(ends)),color='#4B0082',size=1)+
scale_x_reverse('Age (ka)')+
scale_y_continuous('Count (# of papers)',limits=c(0,22.5),expand=c(0,0))+
labs(title="Metanalysis:\nWhen did the 4.2 ka event occur?")+
scale_fill_manual(values = c("darkseagreen", "#4B0082"))+
theme_bw()+
theme(legend.position = c(0.5,0.923),
legend.title = element_blank(),
legend.background = element_rect(fill='grey99',color='grey80'),
legend.direction = 'vertical',
text = element_text(size = 18))
plt2
ggsave(file.path(data_dir,'StartEnd_Hist.png'),dpi = 400, height = 6.5, width = 6, unit = 'in')
plt2 <- ggplot() +
#geom_vline(aes(xintercept = 4.2))+
geom_histogram(aes(x=begs,fill=paste0('Beginning (median=',median(begs),')')),alpha=0.55,binwidth=0.1)+
geom_vline(aes(xintercept=median(begs)),color='darkseagreen4',size=1)+
geom_histogram(aes(x=ends,fill=paste0('End of event (median=',median(ends),')')),alpha=0.55,binwidth=0.1)+
geom_vline(aes(xintercept=median(ends)),color='#4B0082',size=1)+
scale_x_reverse('Age (ka)')+
scale_y_continuous('Count (# of papers)',limits=c(0,22.5),expand=c(0,0))+
labs(title="Metanalysis:\nWhen did the 4.2 ka event occur?")+
scale_fill_manual(values = c("darkseagreen", "#4B0082"))+
theme_bw()+
theme(legend.position = c(0.5,0.923),
legend.title = element_blank(),
legend.background = element_rect(fill='grey99',color='grey80'),
legend.direction = 'vertical',
text = element_text(size = 20))
plt2
ggsave(file.path(data_dir,'StartEnd_Hist.png'),dpi = 400, height = 6.5, width = 6, unit = 'in')
plt2 <- ggplot() +
#geom_vline(aes(xintercept = 4.2))+
geom_histogram(aes(x=begs,fill=paste0('Beginning (median=',median(begs),')')),alpha=0.55,binwidth=0.1)+
geom_vline(aes(xintercept=median(begs)),color='darkseagreen4',size=1)+
geom_histogram(aes(x=ends,fill=paste0('End of event (median=',median(ends),')')),alpha=0.55,binwidth=0.1)+
geom_vline(aes(xintercept=median(ends)),color='#4B0082',size=1)+
scale_x_reverse('Age (ka)')+
scale_y_continuous('Count (# of papers)',limits=c(0,22.5),expand=c(0,0))+
labs(title="Metanalysis:\nWhen did the 4.2 ka event occur?")+
scale_fill_manual(values = c("darkseagreen", "#4B0082"))+
theme_bw()+
theme(legend.position = c(0.8,0.923),
legend.title = element_blank(),
legend.background = element_rect(fill='grey99',color='grey80'),
legend.direction = 'vertical',
text = element_text(size = 19))
plt2
ggsave(file.path(data_dir,'StartEnd_Hist.png'),dpi = 400, height = 6.5, width = 6, unit = 'in')
plt2 <- ggplot() +
#geom_vline(aes(xintercept = 4.2))+
geom_histogram(aes(x=begs,fill=paste0('Beginning (median=',median(begs),')')),alpha=0.55,binwidth=0.1)+
geom_vline(aes(xintercept=median(begs)),color='darkseagreen4',size=1)+
geom_histogram(aes(x=ends,fill=paste0('End of event (median=',median(ends),')')),alpha=0.55,binwidth=0.1)+
geom_vline(aes(xintercept=median(ends)),color='#4B0082',size=1)+
scale_x_reverse('Age (ka)')+
scale_y_continuous('Count (# of papers)',limits=c(0,22.5),expand=c(0,0))+
labs(title="Metanalysis:\nWhen did the 4.2 ka event occur?")+
scale_fill_manual(values = c("darkseagreen", "#4B0082"))+
theme_bw()+
theme(legend.position = c(0.7,0.923),
legend.title = element_blank(),
legend.background = element_rect(fill='grey99',color='grey80'),
legend.direction = 'vertical',
text = element_text(size = 19))
plt2
ggsave(file.path(data_dir,'StartEnd_Hist.png'),dpi = 400, height = 6.5, width = 6, unit = 'in')
plt2 <- ggplot() +
#geom_vline(aes(xintercept = 4.2))+
geom_histogram(aes(x=begs,fill=paste0('Beginning (median=',median(begs),')')),alpha=0.55,binwidth=0.1)+
geom_vline(aes(xintercept=median(begs)),color='darkseagreen4',size=1)+
geom_histogram(aes(x=ends,fill=paste0('End of event (median=',median(ends),')')),alpha=0.55,binwidth=0.1)+
geom_vline(aes(xintercept=median(ends)),color='#4B0082',size=1)+
scale_x_reverse('Age (ka)')+
scale_y_continuous('Count (# of papers)',limits=c(0,22.5),expand=c(0,0))+
labs(title="Metanalysis:\nWhen did the 4.2 ka event occur?")+
scale_fill_manual(values = c("darkseagreen", "#4B0082"))+
theme_bw()+
theme(legend.position = c(0.7,0.923),
legend.title = element_blank(),
legend.background = element_rect(fill='grey99',color='grey80'),
legend.direction = 'vertical',
text = element_text(size = 18))
plt2
ggsave(file.path(data_dir,'StartEnd_Hist.png'),dpi = 400, height = 6.5, width = 6, unit = 'in')
plt2 <- ggplot() +
#geom_vline(aes(xintercept = 4.2))+
geom_histogram(aes(x=begs,fill=paste0('Beginning (median=',median(begs),')')),alpha=0.55,binwidth=0.1)+
geom_vline(aes(xintercept=median(begs)),color='darkseagreen4',size=1)+
geom_histogram(aes(x=ends,fill=paste0('End of event (median=',median(ends),')')),alpha=0.55,binwidth=0.1)+
geom_vline(aes(xintercept=median(ends)),color='#4B0082',size=1)+
scale_x_reverse('Age (ka)')+
scale_y_continuous('Count (# of papers)',limits=c(0,22.5),expand=c(0,0))+
labs(title="Metanalysis:\nWhen did the 4.2 ka event occur?")+
scale_fill_manual(values = c("darkseagreen", "#4B0082"))+
theme_bw()+
theme(legend.position = c(0.73,0.925),
legend.title = element_blank(),
legend.background = element_rect(fill='grey99',color='grey80'),
legend.direction = 'vertical',
text = element_text(size = 18))
plt2
ggsave(file.path(data_dir,'StartEnd_Hist.png'),dpi = 400, height = 6.5, width = 6, unit = 'in')
plt2 <- ggplot() +
#geom_vline(aes(xintercept = 4.2))+
geom_histogram(aes(x=begs,fill=paste0('Beginning (median=',median(begs),')')),alpha=0.55,binwidth=0.1)+
geom_vline(aes(xintercept=median(begs)),color='darkseagreen4',size=1)+
geom_histogram(aes(x=ends,fill=paste0('End of event (median=',median(ends),')')),alpha=0.55,binwidth=0.1)+
geom_vline(aes(xintercept=median(ends)),color='#4B0082',size=1)+
scale_x_reverse('Age (ka)')+
scale_y_continuous('Count (# of papers)',limits=c(0,22.5),expand=c(0,0))+
labs(title="Metanalysis:\nWhen did the 4.2 ka event occur?")+
scale_fill_manual(values = c("darkseagreen", "#4B0082"))+
theme_bw()+
theme(legend.position = c(0.727,0.925),
legend.title = element_blank(),
legend.background = element_rect(fill='grey99',color='grey80'),
legend.direction = 'vertical',
text = element_text(size = 18))
plt2
ggsave(file.path(data_dir,'StartEnd_Hist.png'),dpi = 400, height = 6.5, width = 6, unit = 'in')
plt2 <- ggplot() +
#geom_vline(aes(xintercept = 4.2))+
geom_histogram(aes(x=begs,fill=paste0('Beginning (median=',median(begs),')')),alpha=0.55,binwidth=0.1)+
geom_vline(aes(xintercept=median(begs)),color='darkseagreen4',size=1)+
geom_histogram(aes(x=ends,fill=paste0('End of event (median=',median(ends),')')),alpha=0.55,binwidth=0.1)+
geom_vline(aes(xintercept=median(ends)),color='#4B0082',size=1)+
scale_x_reverse('Age (ka)')+
scale_y_continuous('Count (# of papers)',limits=c(0,22.5),expand=c(0,0))+
labs(title="Metanalysis:\nWhen did the 4.2 ka event occur?")+
scale_fill_manual(values = c("darkseagreen", "#4B0082"))+
theme_bw()+
theme(legend.position = c(0.727,0.925),
legend.title = element_blank(),
legend.background = element_rect(fill='grey99',color='grey80'),
text = element_text(size = 18))
plt2
ggsave(file.path(data_dir,'StartEnd_Hist.png'),dpi = 400, height = 6.5, width = 6, unit = 'in')
plt2 <- ggplot() +
#geom_vline(aes(xintercept = 4.2))+
geom_histogram(aes(x=begs,fill=paste0('Beginning (median=',median(begs),')')),alpha=0.55,binwidth=0.1)+
geom_vline(aes(xintercept=median(begs)),color='darkseagreen4',size=1)+
geom_histogram(aes(x=ends,fill=paste0('End of event (median=',median(ends),')')),alpha=0.55,binwidth=0.1)+
geom_vline(aes(xintercept=median(ends)),color='#4B0082',size=1)+
scale_x_reverse('Age (ka)')+
scale_y_continuous('Count (# of papers)',limits=c(0,22.5),expand=c(0,0))+
labs(title="Metanalysis:\nWhen did the 4.2 ka event occur?")+
scale_fill_manual(values = c("darkseagreen", "#4B0082"))+
theme_bw()+
theme(legend.position = c(0.727,0.925),
legend.title = element_blank(),
legend.background = element_rect(fill='grey99',color=NA),
text = element_text(size = 18))
plt2
ggsave(file.path(data_dir,'StartEnd_Hist.png'),dpi = 400, height = 6.5, width = 6, unit = 'in')
plt2 <- ggplot() +
#geom_vline(aes(xintercept = 4.2))+
geom_histogram(aes(x=begs,fill=paste0('Beginning   (median=',median(begs),')')),alpha=0.55,binwidth=0.1)+
geom_vline(aes(xintercept=median(begs)),color='darkseagreen4',size=1)+
geom_histogram(aes(x=ends,fill=paste0('End of event (median=',median(ends),')')),alpha=0.55,binwidth=0.1)+
geom_vline(aes(xintercept=median(ends)),color='#4B0082',size=1)+
scale_x_reverse('Age (ka)')+
scale_y_continuous('Count (# of papers)',limits=c(0,22.5),expand=c(0,0))+
labs(title="Metanalysis:\nWhen did the 4.2 ka event occur?")+
scale_fill_manual(values = c("darkseagreen", "#4B0082"))+
theme_bw()+
theme(legend.position = c(0.727,0.925),
legend.title = element_blank(),
legend.background = element_rect(fill='grey99',color=NA),
text = element_text(size = 18))
plt2
ggsave(file.path(data_dir,'StartEnd_Hist.png'),dpi = 400, height = 6.5, width = 6, unit = 'in')
plt2 <- ggplot() +
#geom_vline(aes(xintercept = 4.2))+
geom_histogram(aes(x=begs,fill=paste0('Beginning    (median=',median(begs),')')),alpha=0.55,binwidth=0.1)+
geom_vline(aes(xintercept=median(begs)),color='darkseagreen4',size=1)+
geom_histogram(aes(x=ends,fill=paste0('End of event (median=',median(ends),')')),alpha=0.55,binwidth=0.1)+
geom_vline(aes(xintercept=median(ends)),color='#4B0082',size=1)+
scale_x_reverse('Age (ka)')+
scale_y_continuous('Count (# of papers)',limits=c(0,22.5),expand=c(0,0))+
labs(title="Metanalysis:\nWhen did the 4.2 ka event occur?")+
scale_fill_manual(values = c("darkseagreen", "#4B0082"))+
theme_bw()+
theme(legend.position = c(0.727,0.925),
legend.title = element_blank(),
legend.background = element_rect(fill='grey99',color=NA),
text = element_text(size = 18))
plt2
ggsave(file.path(data_dir,'StartEnd_Hist.png'),dpi = 400, height = 6.5, width = 6, unit = 'in')
plt2 <- ggplot() +
#geom_vline(aes(xintercept = 4.2))+
geom_histogram(aes(x=begs,fill=paste0('Beginning   (median=',median(begs),')')),alpha=0.55,binwidth=0.1)+
geom_vline(aes(xintercept=median(begs)),color='darkseagreen4',size=1)+
geom_histogram(aes(x=ends,fill=paste0('End of event (median=',median(ends),')')),alpha=0.55,binwidth=0.1)+
geom_vline(aes(xintercept=median(ends)),color='#4B0082',size=1)+
scale_x_reverse('Age (ka)')+
scale_y_continuous('Count (# of papers)',limits=c(0,22.5),expand=c(0,0))+
labs(title="Metanalysis:\nWhen did the 4.2 ka event occur?")+
scale_fill_manual(values = c("darkseagreen", "#4B0082"))+
theme_bw()+
theme(legend.position = c(0.727,0.925),
legend.title = element_blank(),
legend.background = element_rect(fill='grey99',color=NA),
text = element_text(size = 18))
plt2
ggsave(file.path(data_dir,'StartEnd_Hist.png'),dpi = 400, height = 6.5, width = 6, unit = 'in')
#Plot duration of the 4.2 event
plt3 <- ggplot(data.frame(x=(begs-ends)*1000)) +
#geom_vline(aes(xintercept = 4.2))+
geom_histogram(aes(x=x,fill=paste0('Duration (median=',median(x),')')),alpha=0.9,binwidth = 100)+
geom_vline(aes(xintercept=median(x)),color='#B34C4C',size=1)+
scale_x_continuous('Duration (years)')+
scale_y_continuous('Count (# of papers)',limits=c(0,15),expand=c(0,0))+
labs(title="Metanalysis:\nWhat was the duration of the 4.2 event?")+
scale_fill_manual(values = c("#F08080"))+
theme_bw()+
theme(legend.position = c(0.7,0.923),
legend.title = element_blank(),
legend.background = element_rect(fill='grey99',color='grey80'),
legend.direction = 'horizontal',
text = element_text(size = 18))
plt3
ggsave(file.path(data_dir,'Duration_Hist.png'),dpi = 400, height = 6.5, width = 6, unit = 'in')
#Plot duration of the 4.2 event
plt3 <- ggplot(data.frame(x=(begs-ends)*1000)) +
#geom_vline(aes(xintercept = 4.2))+
geom_histogram(aes(x=x,fill=paste0('Duration (median=',median(x),')')),alpha=0.9,binwidth = 100)+
geom_vline(aes(xintercept=median(x)),color='#B34C4C',size=1)+
scale_x_continuous('Duration (years)')+
scale_y_continuous('Count (# of papers)',limits=c(0,15),expand=c(0,0))+
labs(title="Metanalysis:\nWhat was the duration of the 4.2 event?")+
scale_fill_manual(values = c("#F08080"))+
theme_bw()+
theme(legend.position = c(0.74,0.925),
legend.title = element_blank(),
legend.background = element_rect(fill='grey99',color='grey80'),
legend.direction = 'horizontal',
text = element_text(size = 18))
#Plot duration of the 4.2 event
plt3 <- ggplot(data.frame(x=(begs-ends)*1000)) +
#geom_vline(aes(xintercept = 4.2))+
geom_histogram(aes(x=x,fill=paste0('Duration (median=',median(x),')')),alpha=0.9,binwidth = 100)+
geom_vline(aes(xintercept=median(x)),color='#B34C4C',size=1)+
scale_x_continuous('Duration (years)')+
scale_y_continuous('Count (# of papers)',limits=c(0,15),expand=c(0,0))+
labs(title="Metanalysis:\nWhat was the duration of the 4.2 event?")+
scale_fill_manual(values = c("#F08080"))+
theme_bw()+
theme(legend.position = c(0.74,0.925),
legend.title = element_blank(),
legend.background = element_rect(fill='grey99',color=NA),
legend.direction = 'horizontal',
text = element_text(size = 18))
plt3
ggsave(file.path(data_dir,'Duration_Hist.png'),dpi = 400, height = 6.5, width = 6, unit = 'in')
plt2 <- ggplot() +
#geom_vline(aes(xintercept = 4.2))+
geom_histogram(aes(x=begs,fill=paste0('Beginning (median=',median(begs),')')),alpha=0.55,binwidth=0.1)+
geom_vline(aes(xintercept=median(begs)),color='darkseagreen4',size=1)+
geom_histogram(aes(x=ends,fill=paste0('End of event (median=',median(ends),')')),alpha=0.55,binwidth=0.1)+
geom_vline(aes(xintercept=median(ends)),color='#4B0082',size=1)+
scale_x_reverse('Age (ka)')+
scale_y_continuous('Count (# of papers)',limits=c(0,22.5),expand=c(0,0))+
labs(title="Metanalysis:\nWhen did the 4.2 ka event occur?")+
scale_fill_manual(values = c("darkseagreen", "#4B0082"))+
theme_bw()+
theme(legend.position = c(0.725,0.923),
legend.title = element_blank(),
legend.background = element_rect(fill='grey99',color=NA),
text = element_text(size = 18))
plt2
ggsave(file.path(data_dir,'StartEnd_Hist.png'),dpi = 400, height = 6.5, width = 6, unit = 'in')
source("~/Library/CloudStorage/OneDrive-NorthernArizonaUniversity/Research/Manuscript/HoloceneHydroclimate/HoloceneHydroclimate/Notebooks/2_Analysis/Composite.R", echo=TRUE)
reg
#library(compositeR)
devtools::install("/Users/chrishancock/Library/CloudStorage/OneDrive-NorthernArizonaUniversity/Research/Manuscript/HoloceneHydroclimate/HoloceneHydroclimate/Notebooks/compositeR")
library(compositeR)
library(doParallel)
library(dplyr)
library(foreach)
library(geoChronR)
library(lipdR)
library(magrittr)
library(purrr)
library(tidyverse)
source("~/Library/CloudStorage/OneDrive-NorthernArizonaUniversity/Research/Manuscript/HoloceneHydroclimate/HoloceneHydroclimate/Notebooks/2_Analysis/Composite.R", echo=TRUE)
reg
regN
nThresh
regNames
nens          <- 5     #Ensemble numbers (lower = faster)
binsize       <- 100     #years (median resolution = 109yrs)
ageMin        <- 0       #age BP
ageMax        <- 12400   #age BP
searchDur     <- 3500    #yrs (for 3 lake deposit data points)
nThresh       <- 6       #minimum no. of records, else skip
#Set bin vectors
binvec   <- seq(ageMin-binsize/2, to = ageMax+binsize/2, by = binsize)
binYears <- rowMeans(cbind(binvec[-1],binvec[-length(binvec)]))
#ID regions to reconstruct based on number of records (nThresh)
regNames <- data.frame(name=pullTsVariable(lipdTSO,'geo_ipccRegion')) %>%
group_by(name) %>%
dplyr::summarise(n = n()) %>%
filter(n >= nThresh)
if (var != 'T'){
regNames <- c(as.character(regNames$name),'EAN','SSA') #Add 2 SH regions with fewer records to gain global coverage
}
#Set up data to add once regional composite is calculated
compositeEnsemble <- vector(mode='list')
medianCompositeTS <- data_frame(time=binYears[1:which(binYears==12000)])
#Loop to composite (by region)
for (reg in c(regNames)) {
lipdReg  <- filterTs(lipdTSO,paste('geo_ipccRegion ==',reg))
regN     <- length(lipdReg)
# If sufficient data, use a sample for each iteration
if (regN < 8){        pct <- 1.00
} else if (regN < 30){pct <- 0.75
}else{  pct <- 0.666}
#
#
for (i in 1:length(lipdReg)){
if (lipdReg[[i]]$climateInterpretation1_interpDirection == 'negative'){
lipdReg[[i]]$paleoData_values <- lipdReg[[i]]$paleoData_values*-1
}
}
#
#
set.seed(5) #Reproducibility
ensOut <- foreach(i = 1:nens) %dopar% {
tc <- compositeEnsembles(fTS                  = lipdReg[sample(seq(1,length(lipdReg)),length(lipdReg)*pct)],
binvec               = binvec,
stanFun              = standardizeMeanIteratively,
binFun               = simpleBinTs,
ageVar               = 'age',
alignInterpDirection = FALSE,
spread               = TRUE,
duration             = searchDur,
searchRange          = c(1000,10000),
normalizeVariance    = std,
minN                 = 8)
return(list(composite = tc$composite,count = tc$count))
}
# Reformat Data
regionComposite           <- as.matrix(purrr::map_dfc(ensOut,magrittr::extract,"composite"))
rownames(regionComposite) <- binYears
#Only Holocene
regionComposite           <- regionComposite[1:which(binYears==12000),]
# Rescale for full timeseries
if(std){regionComposite           <- (regionComposite-mean(regionComposite,na.rm=TRUE))/(sd(regionComposite,na.rm=TRUE))}
# Save to matrix
compositeEnsemble[[reg]]  <- regionComposite
medianCompositeTS[[reg]]  <- apply(regionComposite,1,median,na.rm=TRUE)
}
#ID regions to reconstruct based on number of records (nThresh)
regNames <- data.frame(name=pullTsVariable(lipdTSO,'geo_ipccRegion')) %>%
group_by(name) %>%
dplyr::summarise(n = n()) %>%
filter(n >= nThresh)
if (var != 'T'){
regNames <- c(as.character(regNames$name),'EAN','SSA') #Add 2 SH regions with fewer records to gain global coverage
} else{regNames <- c(as.character(regNames$name))}
#Set up data to add once regional composite is calculated
compositeEnsemble <- vector(mode='list')
medianCompositeTS <- data_frame(time=binYears[1:which(binYears==12000)])
#Loop to composite (by region)
for (reg in c(regNames)) {
lipdReg  <- filterTs(lipdTSO,paste('geo_ipccRegion ==',reg))
regN     <- length(lipdReg)
# If sufficient data, use a sample for each iteration
if (regN < 8){        pct <- 1.00
} else if (regN < 30){pct <- 0.75
}else{  pct <- 0.666}
#
#
for (i in 1:length(lipdReg)){
if (lipdReg[[i]]$climateInterpretation1_interpDirection == 'negative'){
lipdReg[[i]]$paleoData_values <- lipdReg[[i]]$paleoData_values*-1
}
}
#
#
set.seed(5) #Reproducibility
ensOut <- foreach(i = 1:nens) %dopar% {
tc <- compositeEnsembles(fTS                  = lipdReg[sample(seq(1,length(lipdReg)),length(lipdReg)*pct)],
binvec               = binvec,
stanFun              = standardizeMeanIteratively,
binFun               = simpleBinTs,
ageVar               = 'age',
alignInterpDirection = FALSE,
spread               = TRUE,
duration             = searchDur,
searchRange          = c(1000,10000),
normalizeVariance    = std,
minN                 = 8)
return(list(composite = tc$composite,count = tc$count))
}
# Reformat Data
regionComposite           <- as.matrix(purrr::map_dfc(ensOut,magrittr::extract,"composite"))
rownames(regionComposite) <- binYears
#Only Holocene
regionComposite           <- regionComposite[1:which(binYears==12000),]
# Rescale for full timeseries
if(std){regionComposite           <- (regionComposite-mean(regionComposite,na.rm=TRUE))/(sd(regionComposite,na.rm=TRUE))}
# Save to matrix
compositeEnsemble[[reg]]  <- regionComposite
medianCompositeTS[[reg]]  <- apply(regionComposite,1,median,na.rm=TRUE)
}
#plot E Asia region to confirm that everything looks good
plotTimeseriesEnsRibbons(X = binYears[1:which(binYears==12000)],Y = compositeEnsemble[['SAS']] )+
scale_x_reverse(name = "age (yr BP)",         oob = scales::squish)+
scale_y_continuous(name = "Standardized Anomaly",oob = scales::squish)+
theme_bw()#+ggtitle(paste("S Asia (using align interpretation = TRUE"))
source("~/Library/CloudStorage/OneDrive-NorthernArizonaUniversity/Research/Manuscript/HoloceneHydroclimate/HoloceneHydroclimate/Notebooks/2_Analysis/Composite.R", echo=TRUE)
#plot E Asia region to confirm that everything looks good
plotTimeseriesEnsRibbons(X = binYears[1:which(binYears==12000)],Y = compositeEnsemble[['SAS']] )+
scale_x_reverse(name = "age (yr BP)",         oob = scales::squish)+
scale_y_continuous(name = "Standardized Anomaly",oob = scales::squish)+
theme_bw()#+ggtitle(paste("S Asia (using align interpretation = TRUE"))
#plot E Asia region to confirm that everything looks good
plotTimeseriesEnsRibbons(X = binYears[1:which(binYears==12000)],Y = compositeEnsemble[['EAS']] )+
scale_x_reverse(name = "age (yr BP)",         oob = scales::squish)+
scale_y_continuous(name = "Standardized Anomaly",oob = scales::squish)+
theme_bw()#+ggtitle(paste("S Asia (using align interpretation = TRUE"))
#plot E Asia region to confirm that everything looks good
plotTimeseriesEnsRibbons(X = binYears[1:which(binYears==12000)],Y = compositeEnsemble[['SOO']] )+
scale_x_reverse(name = "age (yr BP)",         oob = scales::squish)+
scale_y_continuous(name = "Standardized Anomaly",oob = scales::squish)+
theme_bw()#+ggtitle(paste("S Asia (using align interpretation = TRUE"))
#plot E Asia region to confirm that everything looks good
plotTimeseriesEnsRibbons(X = binYears[1:which(binYears==12000)],Y = compositeEnsemble[['WNA']] )+
scale_x_reverse(name = "age (yr BP)",         oob = scales::squish)+
scale_y_continuous(name = "Standardized Anomaly",oob = scales::squish)+
theme_bw()#+ggtitle(paste("S Asia (using align interpretation = TRUE"))
source("~/Library/CloudStorage/OneDrive-NorthernArizonaUniversity/Research/Manuscript/HoloceneHydroclimate/HoloceneHydroclimate/Notebooks/2_Analysis/CompositeCorrelations.R", echo=TRUE)
source("~/Library/CloudStorage/OneDrive-NorthernArizonaUniversity/Research/Manuscript/HoloceneHydroclimate/HoloceneHydroclimate/Notebooks/2_Analysis/CompositeCorrelations.R", echo=TRUE)
correlationEnsemble <- as.data.frame(Proxy_HC_T_Rvals)
names(correlationEnsemble) <- regNames
write.csv(correlationEnsemble,
file=file.path(wd,'Data',
paste('HC_T_RegionalProxyEnsCorrelations.csv',sep='')))
